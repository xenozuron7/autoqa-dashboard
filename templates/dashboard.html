<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="dashboard-container">
        
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-icon">üìä</div>
                <div class="header-text">
                    <h1>Ticket Analytics Dashboard</h1>
                    <p>Real-time performance monitoring and insights</p>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('overview')" id="overviewTab">Overview Dashboard</button>
            <button class="tab-btn" onclick="switchTab('client')" id="clientTab">Client Dashboard</button>
        </div>

        <!-- Overview Dashboard Tab -->
        <div id="overviewContent" class="tab-content active">
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card completed" onclick="openTicketModal('completed')">
                    <div class="stat-icon">‚úì</div>
                    <div class="stat-label">Completed Tickets</div>
                    <div class="stat-value" id="statCompleted">0</div>
                    <div class="stat-subtitle">Successfully resolved</div>
                </div>
                
                <div class="stat-card processing" onclick="openTicketModal('processing')">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-label">Processing Tickets</div>
                    <div class="stat-value" id="statProcessing">0</div>
                    <div class="stat-subtitle">Currently in progress</div>
                </div>
                
                <div class="stat-card failed" onclick="openTicketModal('failed')">
                    <div class="stat-icon">‚úó</div>
                    <div class="stat-label">Failed Tickets</div>
                    <div class="stat-value" id="statFailed">0</div>
                    <div class="stat-subtitle">Requires attention</div>
                </div>
                
                <div class="stat-card callback" onclick="openTicketModal('callback')">
                    <div class="stat-icon">üìû</div>
                    <div class="stat-label">Callback Required</div>
                    <div class="stat-value" id="statCallback">0</div>
                    <div class="stat-subtitle">Awaiting callback</div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-strip">
                    
                    <!-- Date Picker -->
                    <div class="control-group">
                        <label class="control-label">Select Date</label>
                        <input type="date" id="datePicker" class="date-input">
                    </div>

                    <!-- Auto Refresh -->
                    <div class="control-group">
                        <label class="control-label">Auto Refresh</label>
                        <div class="refresh-toggle">
                            <label>
                                <input type="checkbox" id="autoRefresh" class="checkbox-custom" onchange="toggleAutoRefresh()">
                                <span>Every</span>
                            </label>
                            <input type="number" id="refreshInterval" value="30" min="5" max="300" class="refresh-input">
                            <span style="color: #374151; font-size: 15px; font-weight: 600;">sec</span>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div class="control-group">
                        <label class="control-label">&nbsp;</label>
                        <button onclick="reloadData()" class="btn btn-primary">Reload</button>
                    </div>
                    
                </div>
            </div>

            <!-- Date Banner -->
            <div id="dateBanner" class="date-banner">
                <span class="date-banner-icon">üìÖ</span>
                <span class="date-banner-text" id="dateBannerText"></span>
            </div>

            <!-- No Data Message -->
            <div id="noData" class="no-data" style="display: none;">
                <div class="no-data-icon">üìä</div>
                <div class="no-data-text">No data available for the selected date</div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                
                <!-- Completed Chart -->
                <div class="chart-card completed">
                    <div class="chart-header">
                        <div class="chart-icon">‚úì</div>
                        <h2 class="chart-title">Completed Tickets</h2>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="completedChart"></canvas>
                    </div>
                </div>

                <!-- Processing Chart -->
                <div class="chart-card processing">
                    <div class="chart-header">
                        <div class="chart-icon">‚è≥</div>
                        <h2 class="chart-title">Processing Tickets</h2>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="processingChart"></canvas>
                    </div>
                </div>

                <!-- Failed Chart -->
                <div class="chart-card failed">
                    <div class="chart-header">
                        <div class="chart-icon">‚úó</div>
                        <h2 class="chart-title">Failed Tickets</h2>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="failedChart"></canvas>
                    </div>
                </div>

                <!-- Callback Chart -->
                <div class="chart-card callback">
                    <div class="chart-header">
                        <div class="chart-icon">üìû</div>
                        <h2 class="chart-title">Callback Required</h2>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="callbackChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Dashboard Tab -->
        <div id="clientContent" class="tab-content">
            
            <!-- Client Selector -->
            <div class="client-selector">
                <label for="clientSelect">Select Client ID:</label>
                <select id="clientSelect" onchange="loadClientData()">
                    <option value="">-- Select a Client --</option>
                </select>
            </div>

            <!-- Client Stats -->
            <div id="clientStats" class="stats-grid" style="display: none;">
                <div class="stat-card completed">
                    <div class="stat-icon">‚úì</div>
                    <div class="stat-label">Completed Tickets (All Time)</div>
                    <div class="stat-value" id="clientCompleted">0</div>
                </div>
                <div class="stat-card processing">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-label">Processing Tickets (All Time)</div>
                    <div class="stat-value" id="clientProcessing">0</div>
                </div>
                <div class="stat-card failed">
                    <div class="stat-icon">‚úó</div>
                    <div class="stat-label">Failed Tickets (All Time)</div>
                    <div class="stat-value" id="clientFailed">0</div>
                </div>
                <div class="stat-card callback">
                    <div class="stat-icon">üìû</div>
                    <div class="stat-label">Callback Required (All Time)</div>
                    <div class="stat-value" id="clientCallback">0</div>
                </div>
            </div>

            <!-- Client Charts Section -->
            <div id="clientChartsSection" class="charts-section" style="display: none;">
                
                <!-- Completed Chart -->
                <div class="chart-card completed">
                    <div class="chart-header">
                        <div class="chart-icon">‚úì</div>
                        <h2 class="chart-title">Completed Tickets (Past 7 Days)</h2>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="clientCompletedChart"></canvas>
                    </div>
                </div>

                <!-- Processing Chart -->
                <div class="chart-card processing">
                    <div class="chart-header">
                        <div class="chart-icon">‚è≥</div>
                        <h2 class="chart-title">Processing Tickets (Past 7 Days)</h2>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="clientProcessingChart"></canvas>
                    </div>
                </div>

                <!-- Failed Chart -->
                <div class="chart-card failed">
                    <div class="chart-header">
                        <div class="chart-icon">‚úó</div>
                        <h2 class="chart-title">Failed Tickets (Past 7 Days)</h2>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="clientFailedChart"></canvas>
                    </div>
                </div>

                <!-- Callback Chart -->
                <div class="chart-card callback">
                    <div class="chart-header">
                        <div class="chart-icon">üìû</div>
                        <h2 class="chart-title">Callback Required (Past 7 Days)</h2>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="clientCallbackChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- No Data Message -->
            <div id="noClientData" class="no-data" style="display: none;">
                <div class="no-data-icon">üìä</div>
                <div class="no-data-text">No tickets found for this client</div>
            </div>
        </div>

    </div>

    <!-- Ticket Modal -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Tickets</h2>
                <span class="modal-close" onclick="closeTicketModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modalTicketsTable" class="tickets-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticket ID</th>
                                <th>Client ID</th>
                                <th>Status</th>
                                <th>Created At</th>
                                <th>Auto QA Status</th>
                                <th>Request Status</th>
                            </tr>
                        </thead>
                        <tbody id="modalTicketsTableBody">
                            <!-- tickets will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div id="modalNoData" class="no-data" style="display: none;">
                    <div class="no-data-icon">üìä</div>
                    <div class="no-data-text">No tickets found</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let completedChart, processingChart, failedChart, callbackChart;  // chart instances
        let clientCompletedChart, clientProcessingChart, clientFailedChart, clientCallbackChart;  // client chart instances
        let autoRefreshInterval = null;  // refresh timer
        let currentDate = null;  // selected date
        let animationTimers = {};  // animation trackers
        let currentTicketsData = null;  // store current tickets data for modal

        function initializeDatePicker() {  // setup date picker
            const today = new Date().toISOString().split('T')[0];  // get today's date
            document.getElementById('datePicker').value = today;  // set date input value
            currentDate = today;  // store current date
        }

        async function fetchData(date) {  // get data from api
            const url = date ? `/api/ticket-data?date=${date}` : '/api/ticket-data';  // build url
            const response = await fetch(url);  // call api
            return await response.json();  // parse json
        }

        async function fetchDetailedTickets(date, status) {  // get detailed ticket list
            const url = `/api/detailed-tickets?date=${date}&status=${status}`;  // build url with parameters
            const response = await fetch(url);  // call api
            return await response.json();  // parse json
        }

        function updateStats(data) {  // update stat cards
            const totalCompleted = data.completed.reduce((a, b) => a + b, 0);  // sum completed
            const totalProcessing = data.processing.reduce((a, b) => a + b, 0);  // sum processing
            const totalFailed = data.failed.reduce((a, b) => a + b, 0);  // sum failed
            const totalCallback = data.callback.reduce((a, b) => a + b, 0);  // sum callback

            animateValue('statCompleted', totalCompleted);  // animate completed
            animateValue('statProcessing', totalProcessing);  // animate processing
            animateValue('statFailed', totalFailed);  // animate failed
            animateValue('statCallback', totalCallback);  // animate callback
        }

        function animateValue(id, targetValue) {  // animate number changes
            const element = document.getElementById(id);  // get element
            if (animationTimers[id]) {  // already animating?
                clearInterval(animationTimers[id]);  // stop it
                delete animationTimers[id];  // remove timer
            }

            const currentValue = parseInt(element.textContent) || 0;  // current number
            if (currentValue === targetValue) {  // same value?
                element.textContent = targetValue;  // just set it
                return;  // done
            }

            const duration = 800;  // animation duration
            const steps = 40;  // number of steps
            const stepDuration = duration / steps;  // time per step
            const valueChange = targetValue - currentValue;  // total change
            const stepValue = valueChange / steps;  // change per step
            let currentStep = 0;  // start counting

            animationTimers[id] = setInterval(() => {  // run animation
                currentStep++;  // next step
                if (currentStep >= steps) {  // done?
                    element.textContent = targetValue;  // set final
                    clearInterval(animationTimers[id]);  // stop
                    delete animationTimers[id];  // clean up
                } else {  // keep going
                    const newValue = Math.round(currentValue + (stepValue * currentStep));  // calculate
                    element.textContent = newValue;  // update
                }
            }, stepDuration);  // every step
        }

        function showToast(message, type = 'success') {  // show notification
            const toast = document.createElement('div');  // create element
            toast.className = `toast ${type}`;  // set class
            toast.textContent = message;  // set message
            document.body.appendChild(toast);  // add to page

            setTimeout(() => {  // wait 3 seconds
                toast.style.animation = 'slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) reverse';  // slide out
                setTimeout(() => toast.remove(), 400);  // remove
            }, 3000);
        }

        async function openTicketModal(status) {  // show modal with ticket list
            const modalTitle = document.getElementById('modalTitle');  // get modal title
            const modalTableBody = document.getElementById('modalTicketsTableBody');  // get modal table body
            const modalTable = document.getElementById('modalTicketsTable');  // get modal table
            const modalNoData = document.getElementById('modalNoData');  // get no data message
            
            const statusTitles = {  // status title mapping
                'completed': 'Completed Tickets',
                'processing': 'Processing Tickets',
                'failed': 'Failed Tickets',
                'callback': 'Callback Required Tickets'
            };
            modalTitle.textContent = statusTitles[status] || 'Tickets';  // set title
            modalTitle.className = `modal-title-${status}`;  // add status class for coloring
            
            modalTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Loading...</td></tr>';  // show loading
            modalTable.style.display = 'block';  // show table
            modalNoData.style.display = 'none';  // hide no data
            
            document.getElementById('ticketModal').classList.add('is-visible');  // show modal
            document.body.classList.add('modal-open');  // lock body scroll
            
            try {  // attempt to fetch data
                const data = await fetchDetailedTickets(currentDate, status);  // get tickets
                
                if (data.tickets.length === 0) {  // no tickets found
                    modalTable.style.display = 'none';  // hide table
                    modalNoData.style.display = 'block';  // show no data message
                    return;  // done
                }
                
                modalTableBody.innerHTML = '';  // clear table
                data.tickets.forEach(ticket => {  // loop through tickets
                    const row = document.createElement('tr');  // create row
                    row.innerHTML = `
                        <td>${ticket.ticket_id}</td>
                        <td>${ticket.client_id}</td>
                        <td><span class="status-badge ${ticket.status}">${ticket.status.toUpperCase()}</span></td>
                        <td>${ticket.created_at}</td>
                        <td>${ticket.auto_qa_status}</td>
                        <td>${ticket.request_status}</td>
                    `;  // set row content
                    modalTableBody.appendChild(row);  // add row to table
                });
                
            } catch (error) {  // handle errors
                console.error('Error loading tickets:', error);  // log error
                modalTable.style.display = 'none';  // hide table
                modalNoData.style.display = 'block';  // show no data
                showToast('Failed to load tickets', 'error');  // show error toast
            }
        }

        function closeTicketModal() {  // hide modal
            document.getElementById('ticketModal').classList.remove('is-visible');  // hide modal
            document.body.classList.remove('modal-open');  // unlock body scroll
        }

        window.onclick = function(event) {  // handle window clicks
            const modal = document.getElementById('ticketModal');  // get modal
            if (event.target === modal) {  // clicked outside modal content
                closeTicketModal();  // close modal
            }
        };

        function createCharts(data) {  // build/update charts
            const noData = document.getElementById('noData');  // get no data message
            const chartsSection = document.querySelector('#overviewContent .charts-section');  // get charts area
            const dateBanner = document.getElementById('dateBanner');  // get banner

            if (data.client_ids.length === 0) {  // no data?
                noData.style.display = 'block';  // show message
                chartsSection.style.display = 'none';  // hide charts
                dateBanner.style.display = 'none';  // hide banner
                updateStats({completed: [0], processing: [0], failed: [0], callback: [0], client_ids: []});  // zero stats
                return;  // done
            }

            noData.style.display = 'none';  // hide message
            chartsSection.style.display = 'flex';  // show charts
            dateBanner.style.display = 'flex';  // show banner
            updateStats(data);  // update stats

            const displayDate = new Date(currentDate + 'T00:00:00').toLocaleDateString('en-US', {  // format date
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            document.getElementById('dateBannerText').textContent = `Showing data for ${displayDate}`;  // show date

            if (completedChart) completedChart.destroy();  // clear old chart
            if (processingChart) processingChart.destroy();  // clear old chart
            if (failedChart) failedChart.destroy();  // clear old chart
            if (callbackChart) callbackChart.destroy();  // clear old chart

            const chartConfig = {  // chart settings
                responsive: true, maintainAspectRatio: false,
                layout: {padding: {top: 40, bottom: 20, left: 20, right: 20}},
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        backgroundColor: '#111827', padding: 16,
                        titleFont: {size: 15, weight: 'bold', family: 'Inter'},
                        bodyFont: {size: 14, family: 'Inter'},
                        cornerRadius: 12, displayColors: false,
                        callbacks: {label: (context) => `${context.parsed.y} tickets`}
                    },
                    datalabels: {
                        anchor: 'end', align: 'end', offset: -5,
                        formatter: (value) => value > 0 ? value : '',
                        font: {weight: 'bold', size: 16, family: 'Inter'},
                        color: '#111827'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true, grace: '5%',
                        ticks: {stepSize: 1, font: {size: 14, family: 'Inter', weight: '600'}, color: '#6b7280'},
                        grid: {color: '#f3f4f6', drawBorder: false},
                        border: {display: false}
                    },
                    x: {
                        ticks: {font: {size: 13, family: 'Inter', weight: '700'}, color: '#111827', maxRotation: 45, minRotation: 0},
                        grid: {display: false}, border: {display: false}
                    }
                }
            };

            const ctx1 = document.getElementById('completedChart').getContext('2d');  // get canvas
            completedChart = new Chart(ctx1, {type: 'bar', data: {labels: data.client_ids, datasets: [{data: data.completed, backgroundColor: '#10b981', borderRadius: 12, hoverBackgroundColor: '#059669', barPercentage: 0.6, categoryPercentage: 0.9}]}, options: chartConfig, plugins: [ChartDataLabels]});

            const ctx2 = document.getElementById('processingChart').getContext('2d');  // get canvas
            processingChart = new Chart(ctx2, {type: 'bar', data: {labels: data.client_ids, datasets: [{data: data.processing, backgroundColor: '#f59e0b', borderRadius: 12, hoverBackgroundColor: '#d97706', barPercentage: 0.6, categoryPercentage: 0.9}]}, options: chartConfig, plugins: [ChartDataLabels]});

            const ctx3 = document.getElementById('failedChart').getContext('2d');  // get canvas
            failedChart = new Chart(ctx3, {type: 'bar', data: {labels: data.client_ids, datasets: [{data: data.failed, backgroundColor: '#dc2626', borderRadius: 12, hoverBackgroundColor: '#b91c1c', barPercentage: 0.6, categoryPercentage: 0.9}]}, options: chartConfig, plugins: [ChartDataLabels]});

            const ctx4 = document.getElementById('callbackChart').getContext('2d');  // get canvas
            callbackChart = new Chart(ctx4, {type: 'bar', data: {labels: data.client_ids, datasets: [{data: data.callback, backgroundColor: '#8b5cf6', borderRadius: 12, hoverBackgroundColor: '#7c3aed', barPercentage: 0.6, categoryPercentage: 0.9}]}, options: chartConfig, plugins: [ChartDataLabels]});
        }

        async function updateDashboard() {  // refresh everything
            const selectedDate = document.getElementById('datePicker').value;  // get date
            currentDate = selectedDate;  // save it
            const data = await fetchData(selectedDate);  // fetch data
            currentTicketsData = data;  // store for modal use
            createCharts(data);  // update charts
        }

        function toggleAutoRefresh() {  // turn auto-refresh on/off
            const checkbox = document.getElementById('autoRefresh');  // get checkbox
            const intervalInput = document.getElementById('refreshInterval');  // get interval

            if (checkbox.checked) {  // turning on?
                const seconds = parseInt(intervalInput.value);  // get seconds
                autoRefreshInterval = setInterval(updateDashboard, seconds * 1000);  // start timer
                intervalInput.disabled = true;  // lock input
                showToast(`Auto-refresh enabled (${seconds}s)`);  // notify
            } else {  // turning off
                if (autoRefreshInterval) {  // timer exists?
                    clearInterval(autoRefreshInterval);  // stop it
                    autoRefreshInterval = null;  // clear it
                }
                intervalInput.disabled = false;  // unlock input
                showToast('Auto-refresh disabled');  // notify
            }
        }

        async function reloadData() {  // manual refresh
            const btn = event.target.closest('button');  // get button
            const originalHTML = btn.innerHTML;  // save text
            btn.innerHTML = '<span class="loading"></span> Loading...';  // show loading
            btn.disabled = true;  // disable

            await fetch('/reload-data');  // hit reload api
            await updateDashboard();  // refresh

            btn.innerHTML = originalHTML;  // restore text
            btn.disabled = false;  // enable
            showToast('Data reloaded successfully!');  // notify
        }

        function switchTab(tabName) {  // tab switching function
            document.querySelectorAll('.tab-content').forEach(content => {  // hide all tabs
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {  // remove active from buttons
                btn.classList.remove('active');
            });
            
            if (tabName === 'overview') {  // show overview tab
                document.getElementById('overviewContent').classList.add('active');
                document.getElementById('overviewTab').classList.add('active');
            } else if (tabName === 'client') {  // show client tab
                document.getElementById('clientContent').classList.add('active');
                document.getElementById('clientTab').classList.add('active');
                loadClientList();  // load client list when tab is opened
            }
        }

        async function loadClientList() {  // load client list
            try {  // attempt to load
                const response = await fetch('/api/all-clients');  // fetch clients
                const data = await response.json();  // parse json
                
                const selectElement = document.getElementById('clientSelect');  // get dropdown
                selectElement.innerHTML = '<option value="">-- Select a Client --</option>';  // reset options
                
                data.client_ids.forEach(clientId => {  // add each client
                    const option = document.createElement('option');  // create option
                    option.value = clientId;  // set value
                    option.textContent = clientId;  // set text
                    selectElement.appendChild(option);  // add to dropdown
                });
            } catch (error) {  // handle errors
                console.error('Error loading clients:', error);  // log error
                showToast('Failed to load client list', 'error');  // show error
            }
        }

        async function loadClientData() {  // load client data with charts
            const clientId = document.getElementById('clientSelect').value;  // get selected client
            
            if (!clientId) {  // no client selected
                document.getElementById('clientStats').style.display = 'none';  // hide stats
                document.getElementById('clientChartsSection').style.display = 'none';  // hide charts
                document.getElementById('noClientData').style.display = 'none';  // hide no data
                return;  // done
            }
            
            try {  // attempt to load
                const response = await fetch(`/api/client-tickets-7days?client_id=${clientId}`);  // fetch client data
                const data = await response.json();  // parse json
                
                if (!data.success) {  // request failed
                    document.getElementById('clientStats').style.display = 'none';  // hide stats
                    document.getElementById('clientChartsSection').style.display = 'none';  // hide charts
                    document.getElementById('noClientData').style.display = 'block';  // show no data
                    showToast('Failed to load client data', 'error');  // show error
                    return;  // done
                }
                
                if (data.total_tickets === 0) {  // no tickets found
                    document.getElementById('clientStats').style.display = 'none';  // hide stats
                    document.getElementById('clientChartsSection').style.display = 'none';  // hide charts
                    document.getElementById('noClientData').style.display = 'block';  // show no data
                    return;  // done
                }
                
                document.getElementById('noClientData').style.display = 'none';  // hide no data
                document.getElementById('clientStats').style.display = 'grid';  // show stats
                document.getElementById('clientChartsSection').style.display = 'flex';  // show charts
                
                // Update stat cards with ALL TIME data
                document.getElementById('clientCompleted').textContent = data.all_time_stats.completed;  // update completed
                document.getElementById('clientProcessing').textContent = data.all_time_stats.processing;  // update processing
                document.getElementById('clientFailed').textContent = data.all_time_stats.failed;  // update failed
                document.getElementById('clientCallback').textContent = data.all_time_stats.callback;  // update callback
                
                // Create graphs with 7-DAY data
                createClientCharts(data.seven_day_data);  // create charts with 7-day data
                
                showToast(`Loaded ${data.total_tickets} total tickets for ${clientId}`, 'success');  // show success
            } catch (error) {  // handle errors
                console.error('Error loading client data:', error);  // log error
                showToast('Failed to load client data', 'error');  // show error
                document.getElementById('clientStats').style.display = 'none';  // hide stats
                document.getElementById('clientChartsSection').style.display = 'none';  // hide charts
                document.getElementById('noClientData').style.display = 'block';  // show no data
            }
        }

        function createClientCharts(sevenDayData) {  // build client charts
            if (clientCompletedChart) clientCompletedChart.destroy();  // clear old chart
            if (clientProcessingChart) clientProcessingChart.destroy();  // clear old chart
            if (clientFailedChart) clientFailedChart.destroy();  // clear old chart
            if (clientCallbackChart) clientCallbackChart.destroy();  // clear old chart

            const dates = sevenDayData.dates;  // get date labels
            const completedData = sevenDayData.completed;  // completed counts
            const processingData = sevenDayData.processing;  // processing counts
            const failedData = sevenDayData.failed;  // failed counts
            const callbackData = sevenDayData.callback;  // callback counts

            const chartConfig = {  // chart settings
                responsive: true, maintainAspectRatio: false,
                layout: {padding: {top: 40, bottom: 20, left: 20, right: 20}},
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        backgroundColor: '#111827', padding: 16,
                        titleFont: {size: 15, weight: 'bold', family: 'Inter'},
                        bodyFont: {size: 14, family: 'Inter'},
                        cornerRadius: 12, displayColors: false,
                        callbacks: {label: (context) => `${context.parsed.y} tickets`}
                    },
                    datalabels: {
                        anchor: 'end', align: 'end', offset: -5,
                        formatter: (value) => value > 0 ? value : '',
                        font: {weight: 'bold', size: 16, family: 'Inter'},
                        color: '#111827'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true, grace: '5%',
                        ticks: {stepSize: 1, font: {size: 14, family: 'Inter', weight: '600'}, color: '#6b7280'},
                        grid: {color: '#f3f4f6', drawBorder: false},
                        border: {display: false}
                    },
                    x: {
                        ticks: {
                            font: {size: 13, family: 'Inter', weight: '600'}, 
                            color: '#111827', 
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: false
                        },
                        grid: {display: false}, 
                        border: {display: false}
                    }
                }
            };

            const ctx1 = document.getElementById('clientCompletedChart').getContext('2d');  // get canvas
            clientCompletedChart = new Chart(ctx1, {type: 'bar', data: {labels: dates, datasets: [{data: completedData, backgroundColor: '#10b981', borderRadius: 12, hoverBackgroundColor: '#059669', barPercentage: 0.6, categoryPercentage: 0.9}]}, options: chartConfig, plugins: [ChartDataLabels]});

            const ctx2 = document.getElementById('clientProcessingChart').getContext('2d');  // get canvas
            clientProcessingChart = new Chart(ctx2, {type: 'bar', data: {labels: dates, datasets: [{data: processingData, backgroundColor: '#f59e0b', borderRadius: 12, hoverBackgroundColor: '#d97706', barPercentage: 0.6, categoryPercentage: 0.9}]}, options: chartConfig, plugins: [ChartDataLabels]});

            const ctx3 = document.getElementById('clientFailedChart').getContext('2d');  // get canvas
            clientFailedChart = new Chart(ctx3, {type: 'bar', data: {labels: dates, datasets: [{data: failedData, backgroundColor: '#dc2626', borderRadius: 12, hoverBackgroundColor: '#b91c1c', barPercentage: 0.6, categoryPercentage: 0.9}]}, options: chartConfig, plugins: [ChartDataLabels]});

            const ctx4 = document.getElementById('clientCallbackChart').getContext('2d');  // get canvas
            clientCallbackChart = new Chart(ctx4, {type: 'bar', data: {labels: dates, datasets: [{data: callbackData, backgroundColor: '#8b5cf6', borderRadius: 12, hoverBackgroundColor: '#7c3aed', barPercentage: 0.6, categoryPercentage: 0.9}]}, options: chartConfig, plugins: [ChartDataLabels]});
        }

        document.getElementById('datePicker').addEventListener('change', updateDashboard);  // watch date changes

        window.onload = async function() {  // on page load
            initializeDatePicker();  // setup date
            await updateDashboard();  // load data
        };
    </script>
</body>
</html>
