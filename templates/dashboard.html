<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Auto QA Analytics Dashboard - Real-time ticket monitoring">
    <meta name="theme-color" content="#030712">
    <title>Auto QA Analytics Dashboard</title>

    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;450;500;550;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <!-- Ambient Background with Floating Orbs -->
    <div class="ambient-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <div class="app-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">üìä</div>
                    <div class="logo-text">
                        <span class="logo-title">AutoQA</span>
                        <span class="logo-subtitle">Analytics</span>
                    </div>
                </div>
            </div>

            <nav class="nav-menu">
                <button class="nav-item active" onclick="switchTab('overview')">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-label">Overview</span>
                </button>
                <button class="nav-item" onclick="switchTab('client')">
                    <span class="nav-icon">üë§</span>
                    <span class="nav-label">Clients</span>
                </button>
                <button class="nav-item" onclick="switchTab('date-range')">
                    <span class="nav-icon">üìÖ</span>
                    <span class="nav-label">Date Range</span>
                </button>
                <button class="nav-item" onclick="switchTab('token-analytics')">
                    <span class="nav-icon">üéØ</span>
                    <span class="nav-label">Tokens</span>
                </button>
            </nav>

            <div class="sidebar-footer">
                <div class="refresh-controls">
                    <label class="toggle-wrap">
                        <input type="checkbox" id="auto-refresh-toggle">
                        <span class="toggle-label">Auto Refresh</span>
                    </label>
                    <div class="interval-input">
                        <input type="number" id="refresh-interval" value="30" min="5" max="300" disabled>
                        <span>sec</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Tab -->
            <section id="overview-tab" class="tab-panel active">
                <header class="page-header">
                    <div class="header-left">
                        <h1 class="page-title">Dashboard Overview</h1>
                        <p class="page-subtitle">Real-time ticket monitoring and analysis</p>
                    </div>
                    <div class="header-controls">
                        <input type="date" id="overview-date" class="input-field">
                        <button class="btn-icon" onclick="manualReload()" title="Reload">
                            <span>üîÑ</span>
                        </button>
                    </div>
                </header>

                <!-- Date Display -->
                <div class="date-display" id="overview-date-banner">
                    <span class="date-icon">üìÖ</span>
                    <span class="date-text" id="overview-date-text">Loading...</span>
                </div>

                <!-- Stats Cards -->
                <div class="stats-row">
                    <div class="stat-card completed" onclick="openTicketModal('completed')">
                        <div class="stat-header">
                            <span class="stat-icon">‚úÖ</span>
                            <span class="stat-trend" id="completed-trend"></span>
                        </div>
                        <div class="stat-value" id="completed-count">0</div>
                        <div class="stat-label">Completed</div>
                    </div>

                    <div class="stat-card processing" onclick="openTicketModal('processing')">
                        <div class="stat-header">
                            <span class="stat-icon">‚öôÔ∏è</span>
                            <span class="stat-trend" id="processing-trend"></span>
                        </div>
                        <div class="stat-value" id="processing-count">0</div>
                        <div class="stat-label">Processing</div>
                    </div>

                    <div class="stat-card failed" onclick="openTicketModal('failed')">
                        <div class="stat-header">
                            <span class="stat-icon">‚ùå</span>
                            <span class="stat-trend" id="failed-trend"></span>
                        </div>
                        <div class="stat-value" id="failed-count">0</div>
                        <div class="stat-label">Failed</div>
                    </div>

                    <div class="stat-card callback" onclick="openTicketModal('callback')">
                        <div class="stat-header">
                            <span class="stat-icon">üìû</span>
                            <span class="stat-trend" id="callback-trend"></span>
                        </div>
                        <div class="stat-value" id="callback-count">0</div>
                        <div class="stat-label">Callback</div>
                    </div>
                </div>

                <!-- No Data Message -->
                <div id="overview-no-data" class="empty-state" style="display: none;">
                    <div class="empty-icon">üì≠</div>
                    <div class="empty-title">No data available</div>
                    <div class="empty-text">Select a different date to view ticket data</div>
                </div>

                <!-- Charts Grid -->
                <div id="overview-charts" class="charts-grid" style="display: none;">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">
                                <span class="chart-dot completed"></span>
                                Completed Tickets
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="completedChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">
                                <span class="chart-dot processing"></span>
                                Processing Tickets
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="processingChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">
                                <span class="chart-dot failed"></span>
                                Failed Tickets
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="failedChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">
                                <span class="chart-dot callback"></span>
                                Callback Required
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="callbackChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Client Tab -->
            <section id="client-tab" class="tab-panel">
                <header class="page-header">
                    <div class="header-left">
                        <h1 class="page-title">Client Dashboard</h1>
                        <p class="page-subtitle">View individual client performance</p>
                    </div>
                </header>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label class="filter-label">Select Client</label>
                        <select id="client-id-select" class="input-field" onchange="loadClientData()">
                            <option value="">-- Select a Client --</option>
                        </select>
                    </div>
                </div>

                <div id="client-data-container" style="display: none;">
                    <div class="stats-row">
                        <div class="stat-card completed">
                            <div class="stat-header">
                                <span class="stat-icon">‚úÖ</span>
                            </div>
                            <div class="stat-value" id="client-completed-count">0</div>
                            <div class="stat-label">Completed (7 Days)</div>
                        </div>

                        <div class="stat-card processing">
                            <div class="stat-header">
                                <span class="stat-icon">‚öôÔ∏è</span>
                            </div>
                            <div class="stat-value" id="client-processing-count">0</div>
                            <div class="stat-label">Processing (7 Days)</div>
                        </div>

                        <div class="stat-card failed">
                            <div class="stat-header">
                                <span class="stat-icon">‚ùå</span>
                            </div>
                            <div class="stat-value" id="client-failed-count">0</div>
                            <div class="stat-label">Failed (7 Days)</div>
                        </div>

                        <div class="stat-card callback">
                            <div class="stat-header">
                                <span class="stat-icon">üìû</span>
                            </div>
                            <div class="stat-value" id="client-callback-count">0</div>
                            <div class="stat-label">Callback (7 Days)</div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <span class="chart-dot completed"></span>
                                    Completed (7 Days)
                                </div>
                            </div>
                            <div class="chart-body">
                                <canvas id="clientCompletedChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <span class="chart-dot processing"></span>
                                    Processing (7 Days)
                                </div>
                            </div>
                            <div class="chart-body">
                                <canvas id="clientProcessingChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <span class="chart-dot failed"></span>
                                    Failed (7 Days)
                                </div>
                            </div>
                            <div class="chart-body">
                                <canvas id="clientFailedChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <span class="chart-dot callback"></span>
                                    Callback (7 Days)
                                </div>
                            </div>
                            <div class="chart-body">
                                <canvas id="clientCallbackChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="client-no-data" class="empty-state">
                    <div class="empty-icon">üë§</div>
                    <div class="empty-title">Select a client</div>
                    <div class="empty-text">Choose a client from the dropdown to view their data</div>
                </div>
            </section>

            <!-- Date Range Tab -->
            <section id="date-range-tab" class="tab-panel">
                <header class="page-header">
                    <div class="header-left">
                        <h1 class="page-title">Date Range Analysis</h1>
                        <p class="page-subtitle">Analyze ticket trends over time</p>
                    </div>
                </header>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label class="filter-label">Start Date</label>
                        <input type="date" id="range-start-date" class="input-field">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">End Date</label>
                        <input type="date" id="range-end-date" class="input-field">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Filter Clients</label>
                        <div class="multi-select-wrapper">
                            <div class="multi-select-trigger" id="client-multi-select-trigger"
                                onclick="toggleClientDropdown()">
                                <span id="client-selected-text">All Clients</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </div>
                            <div class="multi-select-dropdown" id="client-dropdown" style="display: none;">
                                <div class="multi-select-search">
                                    <input type="text" id="client-search" placeholder="Search clients..."
                                        oninput="filterClients()">
                                </div>
                                <div class="multi-select-options" id="client-options"></div>
                                <div class="multi-select-actions">
                                    <button class="btn-small" onclick="selectAllClients()">Select All</button>
                                    <button class="btn-small" onclick="clearAllClients()">Clear All</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="analyzeRange()">
                        <span>üìä</span> Analyze
                    </button>
                </div>

                <div id="range-results" style="display: none;">
                    <div class="stats-row">
                        <div class="stat-card completed">
                            <div class="stat-header"><span class="stat-icon">‚úÖ</span></div>
                            <div class="stat-value" id="range-completed">0</div>
                            <div class="stat-label">Total Completed</div>
                        </div>
                        <div class="stat-card processing">
                            <div class="stat-header"><span class="stat-icon">‚öôÔ∏è</span></div>
                            <div class="stat-value" id="range-processing">0</div>
                            <div class="stat-label">Total Processing</div>
                        </div>
                        <div class="stat-card failed">
                            <div class="stat-header"><span class="stat-icon">‚ùå</span></div>
                            <div class="stat-value" id="range-failed">0</div>
                            <div class="stat-label">Total Failed</div>
                        </div>
                        <div class="stat-card callback">
                            <div class="stat-header"><span class="stat-icon">üìû</span></div>
                            <div class="stat-value" id="range-callback">0</div>
                            <div class="stat-label">Total Callback</div>
                        </div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">üìà Daily Ticket Trend</div>
                        </div>
                        <div class="chart-body large">
                            <canvas id="rangeTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="section-title">Client Breakdown</div>
                    <div class="client-grid" id="rangeClientCards"></div>
                </div>

                <div id="range-no-data" class="empty-state">
                    <div class="empty-icon">üìÖ</div>
                    <div class="empty-title">Select date range</div>
                    <div class="empty-text">Choose start and end dates to analyze ticket data</div>
                </div>
            </section>

            <!-- Token Analytics Tab -->
            <section id="token-analytics-tab" class="tab-panel">
                <header class="page-header">
                    <div class="header-left">
                        <h1 class="page-title">Token Analytics</h1>
                        <p class="page-subtitle">Track API usage and costs</p>
                    </div>
                </header>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label class="filter-label">Start Date</label>
                        <input type="date" id="token-start-date" class="input-field">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">End Date</label>
                        <input type="date" id="token-end-date" class="input-field">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Client</label>
                        <select id="token-client-select" class="input-field">
                            <option value="all">All Clients</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="analyzeTokens()">
                        <span>üìä</span> Analyze
                    </button>
                </div>

                <div id="token-results" style="display: none;">
                    <div class="stats-row">
                        <div class="stat-card blue">
                            <div class="stat-header"><span class="stat-icon">üéØ</span></div>
                            <div class="stat-value" id="token-total-tokens">0</div>
                            <div class="stat-label">Total Tokens</div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-header"><span class="stat-icon">üí∞</span></div>
                            <div class="stat-value" id="token-total-cost">$0.00</div>
                            <div class="stat-label">Total Cost</div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-header"><span class="stat-icon">üìù</span></div>
                            <div class="stat-value" id="token-requests">0</div>
                            <div class="stat-label">API Requests</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-header"><span class="stat-icon">ü§ñ</span></div>
                            <div class="stat-value" id="token-models">0</div>
                            <div class="stat-label">Models Used</div>
                        </div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">üìä Token Usage by Model</div>
                        </div>
                        <div class="chart-body large">
                            <canvas id="tokenChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="token-no-data" class="empty-state">
                    <div class="empty-icon">üéØ</div>
                    <div class="empty-title">Analyze token usage</div>
                    <div class="empty-text">Select a date range and client to view token analytics</div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Tickets</h2>
                <button class="modal-close" onclick="closeTicketModal()">&times;</button>
            </div>
            <div class="modal-body">
                <table class="data-table" id="ticketsTable">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Client ID</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Auto QA Status</th>
                            <th>Request Status</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // DATA LABELS PLUGIN
        // ============================================================================
        const dataLabelsPlugin = {
            id: 'dataLabels',
            afterDatasetsDraw(chart) {
                const { ctx, data } = chart;
                ctx.save();
                data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (!meta || !meta.data) return;
                    meta.data.forEach((point, idx) => {
                        const val = dataset.data[idx];
                        if (!val || val === 0) return;
                        ctx.font = 'bold 11px Inter, sans-serif';
                        ctx.fillStyle = '#94a3b8';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        let txt = val.toLocaleString();
                        if (val >= 1000000) txt = (val / 1000000).toFixed(1) + 'M';
                        else if (val >= 1000) txt = (val / 1000).toFixed(1) + 'K';
                        ctx.fillText(txt, point.x, point.y - 6);
                    });
                });
                ctx.restore();
            }
        };
        if (typeof Chart !== 'undefined') Chart.register(dataLabelsPlugin);

        // ============================================================================
        // GLOBAL VARIABLES
        // ============================================================================
        let charts = {
            completed: null, processing: null, failed: null, callback: null,
            clientCompleted: null, clientProcessing: null, clientFailed: null, clientCallback: null,
            rangeTrend: null, rangeClient: null, token: null
        };
        let refreshInterval = null;
        let selectedClients = new Set();
        let allClients = [];

        // ============================================================================
        // STATE PERSISTENCE
        // ============================================================================
        const DASH_STATE_KEY = 'autoqa_dashboard_state_v2';

        function readDashboardState() {
            try {
                const raw = localStorage.getItem(DASH_STATE_KEY);
                return raw ? JSON.parse(raw) : null;
            } catch (e) { return null; }
        }

        function writeDashboardState(patch) {
            try {
                const cur = readDashboardState() || {};
                const next = { ...cur, ...patch, updatedAt: new Date().toISOString() };
                localStorage.setItem(DASH_STATE_KEY, JSON.stringify(next));
            } catch (e) { }
        }

        function persistCurrentState() {
            const state = {
                activeTab: getActiveTabName(),
                overviewDate: document.getElementById('overview-date')?.value || '',
                rangeStart: document.getElementById('range-start-date')?.value || '',
                rangeEnd: document.getElementById('range-end-date')?.value || '',
                tokenStart: document.getElementById('token-start-date')?.value || '',
                tokenEnd: document.getElementById('token-end-date')?.value || '',
                tokenClient: document.getElementById('token-client-select')?.value || 'all',
                autoRefreshEnabled: document.getElementById('auto-refresh-toggle')?.checked || false,
                refreshInterval: document.getElementById('refresh-interval')?.value || '30',
                selectedClientId: document.getElementById('client-id-select')?.value || '',
                selectedClients: Array.from(selectedClients || [])
            };
            writeDashboardState(state);
        }

        function getActiveTabName() {
            const active = document.querySelector('.tab-panel.active');
            if (!active || !active.id) return 'overview';
            return active.id.replace('-tab', '');
        }

        // ============================================================================
        // TAB SWITCHING
        // ============================================================================
        function switchTab(tabName) {
            writeDashboardState({ activeTab: tabName });

            // Save active tab to localStorage
            localStorage.setItem('activeTab', tabName);

            document.querySelectorAll('.tab-panel').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.closest('.nav-item').classList.add('active');

            if (tabName === 'overview') loadOverviewData();
            else if (tabName === 'client') loadClientList();
            else if (tabName === 'date-range') loadClientListForRange();
            else if (tabName === 'token-analytics') {
                loadTokenAnalyticsClients();
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 7);
                document.getElementById('token-end-date').valueAsDate = endDate;
                document.getElementById('token-start-date').valueAsDate = startDate;
            }
        }

        // ============================================================================
        // OVERVIEW FUNCTIONS
        // ============================================================================
        async function loadOverviewData() {
            const dateInput = document.getElementById('overview-date');
            const selectedDate = dateInput.value;
            if (!selectedDate) return;

            try {
                const response = await fetch(`/api/overview?date=${selectedDate}`);
                const data = await response.json();

                const dateObj = new Date(selectedDate);
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                document.getElementById('overview-date-text').textContent = formattedDate;

                document.getElementById('completed-count').textContent = data.stats.completed || 0;
                document.getElementById('processing-count').textContent = data.stats.processing || 0;
                document.getElementById('failed-count').textContent = data.stats.failed || 0;
                document.getElementById('callback-count').textContent = data.stats.callback || 0;

                const hasData = data.stats.completed > 0 || data.stats.processing > 0 ||
                    data.stats.failed > 0 || data.stats.callback > 0;

                if (hasData) {
                    document.getElementById('overview-no-data').style.display = 'none';
                    document.getElementById('overview-charts').style.display = 'grid';
                    createChart('completedChart', 'Completed', data.charts.completed || {}, '#22c55e');
                    createChart('processingChart', 'Processing', data.charts.processing || {}, '#f59e0b');
                    createChart('failedChart', 'Failed', data.charts.failed || {}, '#ef4444');
                    createChart('callbackChart', 'Callback', data.charts.callback || {}, '#8b5cf6');
                } else {
                    document.getElementById('overview-no-data').style.display = 'flex';
                    document.getElementById('overview-charts').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading overview:', error);
                showToast('Error loading overview data', 'error');
            }
        }

        function createChart(canvasId, label, chartData, color) {
            const ctx = document.getElementById(canvasId);
            const chartKey = canvasId.replace('Chart', '');
            if (charts[chartKey]) charts[chartKey].destroy();

            const labels = Object.keys(chartData);
            const data = Object.values(chartData);
            const maxValue = Math.max(...data, 1);
            const suggestedMax = Math.ceil(maxValue * 1.15);

            // Vibrant gradient
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 280);
            gradient.addColorStop(0, color + '65');
            gradient.addColorStop(0.5, color + '35');
            gradient.addColorStop(1, color + '10');

            charts[chartKey] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: gradient,
                        borderColor: color,
                        borderWidth: 2,
                        borderRadius: 6,
                        barPercentage: 0.7,
                        borderSkipped: false,
                        hoverBackgroundColor: color + '70',
                        hoverBorderColor: color
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 600,
                        easing: 'easeOutQuart'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.95)',
                            borderColor: 'rgba(255, 255, 255, 0.08)',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: { size: 12, weight: '500', family: "'Inter', sans-serif" },
                            bodyFont: { size: 11, family: "'Inter', sans-serif" },
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                title: (items) => items[0].label,
                                label: (item) => `${label}: ${item.parsed.y.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: suggestedMax,
                            border: { display: false },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.35)',
                                font: { size: 10, weight: '500' },
                                padding: 8,
                                callback: (value) => value >= 1000 ? (value / 1000).toFixed(0) + 'K' : value
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.04)',
                                lineWidth: 1
                            }
                        },
                        x: {
                            border: { display: false },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.35)',
                                font: { size: 10, weight: '500' },
                                maxRotation: 45,
                                padding: 4
                            },
                            grid: { display: false }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function manualReload() {
            loadOverviewData();
            showToast('Data reloaded', 'success');
        }

        // Auto-refresh
        document.getElementById('auto-refresh-toggle').addEventListener('change', function (e) {
            const intervalInput = document.getElementById('refresh-interval');
            intervalInput.disabled = !e.target.checked;

            if (e.target.checked) {
                const seconds = parseInt(intervalInput.value);
                refreshInterval = setInterval(loadOverviewData, seconds * 1000);
                showToast(`Auto-refresh enabled (${seconds}s)`, 'success');
            } else {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                showToast('Auto-refresh disabled', 'success');
            }
            persistCurrentState();
        });

        // ============================================================================
        // CLIENT FUNCTIONS
        // ============================================================================
        async function loadClientList() {
            try {
                const response = await fetch('/api/clients');
                const data = await response.json();
                const select = document.getElementById('client-id-select');
                select.innerHTML = '<option value="">-- Select a Client --</option>';
                data.client_ids.forEach(clientId => {
                    const option = document.createElement('option');
                    option.value = clientId;
                    option.textContent = clientId;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        async function loadClientData() {
            const clientId = document.getElementById('client-id-select').value;

            if (!clientId) {
                document.getElementById('client-data-container').style.display = 'none';
                document.getElementById('client-no-data').style.display = 'flex';
                return;
            }

            try {
                const response = await fetch(`/api/client/${clientId}`);
                const data = await response.json();

                if (data.total_tickets === 0) {
                    document.getElementById('client-data-container').style.display = 'none';
                    document.getElementById('client-no-data').style.display = 'flex';
                    return;
                }

                document.getElementById('client-data-container').style.display = 'block';
                document.getElementById('client-no-data').style.display = 'none';

                document.getElementById('client-completed-count').textContent = data.stats.completed || 0;
                document.getElementById('client-processing-count').textContent = data.stats.processing || 0;
                document.getElementById('client-failed-count').textContent = data.stats.failed || 0;
                document.getElementById('client-callback-count').textContent = data.stats.callback || 0;

                createClientChart('clientCompletedChart', 'Completed', data.daily.completed || {}, '#22c55e');
                createClientChart('clientProcessingChart', 'Processing', data.daily.processing || {}, '#f59e0b');
                createClientChart('clientFailedChart', 'Failed', data.daily.failed || {}, '#ef4444');
                createClientChart('clientCallbackChart', 'Callback', data.daily.callback || {}, '#8b5cf6');

                persistCurrentState();
            } catch (error) {
                console.error('Error loading client data:', error);
                showToast('Error loading client data', 'error');
            }
        }

        function createClientChart(canvasId, label, chartData, color) {
            const ctx = document.getElementById(canvasId);
            const chartKey = canvasId.replace('Chart', '');
            if (charts[chartKey]) charts[chartKey].destroy();

            const labels = Object.keys(chartData);
            const data = Object.values(chartData);
            const maxValue = Math.max(...data, 1);

            // Vibrant gradient
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 280);
            gradient.addColorStop(0, color + '65');
            gradient.addColorStop(0.5, color + '35');
            gradient.addColorStop(1, color + '10');

            charts[chartKey] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: gradient,
                        borderColor: color,
                        borderWidth: 2,
                        borderRadius: 6,
                        barPercentage: 0.7,
                        hoverBackgroundColor: color + '70',
                        hoverBorderColor: color
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 600, easing: 'easeOutQuart' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.95)',
                            borderColor: 'rgba(255, 255, 255, 0.08)',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 12, weight: '500' },
                            bodyFont: { size: 11 },
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: Math.ceil(maxValue * 1.15),
                            border: { display: false },
                            ticks: { color: 'rgba(255, 255, 255, 0.35)', font: { size: 10, weight: '500' }, padding: 8 },
                            grid: { color: 'rgba(255, 255, 255, 0.04)' }
                        },
                        x: {
                            border: { display: false },
                            ticks: { color: 'rgba(255, 255, 255, 0.35)', font: { size: 10, weight: '500' } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ============================================================================
        // DATE RANGE FUNCTIONS
        // ============================================================================
        async function loadClientListForRange() {
            try {
                const response = await fetch('/api/clients');
                const data = await response.json();
                allClients = data.client_ids;

                const container = document.getElementById('client-options');
                container.innerHTML = '';
                allClients.forEach(clientId => {
                    const div = document.createElement('div');
                    div.className = 'multi-select-option';
                    div.innerHTML = `<input type="checkbox" value="${clientId}" onchange="updateSelectedClients()"><span>${clientId}</span>`;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        function toggleClientDropdown() {
            const dropdown = document.getElementById('client-dropdown');
            const trigger = document.getElementById('client-multi-select-trigger');
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'flex';
                trigger.classList.add('open');
            } else {
                dropdown.style.display = 'none';
                trigger.classList.remove('open');
            }
        }

        function filterClients() {
            const searchTerm = document.getElementById('client-search').value.toLowerCase();
            document.querySelectorAll('.multi-select-option').forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function updateSelectedClients() {
            selectedClients.clear();
            document.querySelectorAll('#client-options input[type="checkbox"]:checked').forEach(cb => selectedClients.add(cb.value));
            const text = selectedClients.size === 0 ? 'All Clients' : `${selectedClients.size} selected`;
            document.getElementById('client-selected-text').textContent = text;
            persistCurrentState();
        }

        function selectAllClients() {
            document.querySelectorAll('#client-options input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateSelectedClients();
        }

        function clearAllClients() {
            document.querySelectorAll('#client-options input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSelectedClients();
        }

        document.addEventListener('click', function (event) {
            const wrapper = document.querySelector('.multi-select-wrapper');
            if (wrapper && !wrapper.contains(event.target)) {
                document.getElementById('client-dropdown').style.display = 'none';
                document.getElementById('client-multi-select-trigger').classList.remove('open');
            }
        });

        async function analyzeRange() {
            const startDate = document.getElementById('range-start-date').value;
            const endDate = document.getElementById('range-end-date').value;

            if (!startDate || !endDate) {
                showToast('Please select both dates', 'error');
                return;
            }

            const resultsDiv = document.getElementById('range-results');
            const noDataDiv = document.getElementById('range-no-data');

            resultsDiv.style.display = 'none';
            noDataDiv.style.display = 'flex';
            noDataDiv.innerHTML = '<div class="empty-icon"><div class="loading"></div></div><div class="empty-title">Analyzing...</div>';

            try {
                let url = `/api/ticket-data-range?start_date=${startDate}&end_date=${endDate}`;
                if (selectedClients.size > 0) {
                    url += `&client_ids=${Array.from(selectedClients).join(',')}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (!data.success) throw new Error(data.error || 'Failed to fetch data');

                document.getElementById('range-completed').textContent = data.total_stats.completed || 0;
                document.getElementById('range-processing').textContent = data.total_stats.processing || 0;
                document.getElementById('range-failed').textContent = data.total_stats.failed || 0;
                document.getElementById('range-callback').textContent = data.total_stats.callback || 0;

                createRangeTrendChart(data.daily_breakdown);
                createRangeClientChart(data.client_breakdown);

                noDataDiv.style.display = 'none';
                resultsDiv.style.display = 'block';
                showToast('Analysis complete', 'success');
            } catch (error) {
                console.error('Range analysis error:', error);
                noDataDiv.innerHTML = `<div class="empty-icon">‚ùå</div><div class="empty-title">Error</div><div class="empty-text">${error.message}</div>`;
                showToast('Error analyzing data', 'error');
            }
        }

        function createRangeTrendChart(dailyData) {
            const ctx = document.getElementById('rangeTrendChart');
            if (charts.rangeTrend) charts.rangeTrend.destroy();

            charts.rangeTrend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyData.dates || [],
                    datasets: [
                        { label: 'Completed', data: dailyData.completed || [], backgroundColor: 'rgba(34, 197, 94, 0.45)', borderColor: 'rgba(34, 197, 94, 0.8)', borderWidth: 1, borderRadius: 4, hoverBackgroundColor: 'rgba(34, 197, 94, 0.65)' },
                        { label: 'Processing', data: dailyData.processing || [], backgroundColor: 'rgba(245, 158, 11, 0.45)', borderColor: 'rgba(245, 158, 11, 0.8)', borderWidth: 1, borderRadius: 4, hoverBackgroundColor: 'rgba(245, 158, 11, 0.65)' },
                        { label: 'Failed', data: dailyData.failed || [], backgroundColor: 'rgba(239, 68, 68, 0.45)', borderColor: 'rgba(239, 68, 68, 0.8)', borderWidth: 1, borderRadius: 4, hoverBackgroundColor: 'rgba(239, 68, 68, 0.65)' },
                        { label: 'Callback', data: dailyData.callback || [], backgroundColor: 'rgba(139, 92, 246, 0.45)', borderColor: 'rgba(139, 92, 246, 0.8)', borderWidth: 1, borderRadius: 4, hoverBackgroundColor: 'rgba(139, 92, 246, 0.65)' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 600, easing: 'easeOutQuart' },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.5)',
                                font: { size: 11, weight: '500' },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 16,
                                boxWidth: 6,
                                boxHeight: 6
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.95)',
                            borderColor: 'rgba(255, 255, 255, 0.08)',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 12, weight: '500' },
                            bodyFont: { size: 11 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            border: { display: false },
                            ticks: { color: 'rgba(255, 255, 255, 0.35)', font: { size: 10, weight: '500' }, padding: 8 },
                            grid: { color: 'rgba(255, 255, 255, 0.04)' }
                        },
                        x: {
                            border: { display: false },
                            ticks: { color: 'rgba(255, 255, 255, 0.35)', font: { size: 10, weight: '500' }, maxRotation: 45 },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createRangeClientChart(clientData) {
            const container = document.getElementById('rangeClientCards');
            container.innerHTML = '';

            const clients = Object.keys(clientData || {});
            clients.sort((a, b) => (clientData[b]?.total || 0) - (clientData[a]?.total || 0));
            const topClients = clients.slice(0, 10);

            topClients.forEach(clientId => {
                const d = clientData[clientId] || {};
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div class="client-header">${clientId}</div>
                    <div class="client-stats">
                        <div class="client-stat"><span>Total</span><strong>${(d.total || 0).toLocaleString()}</strong></div>
                        <div class="client-stat"><span>Completed</span><strong class="completed">${(d.completed || 0).toLocaleString()}</strong></div>
                        <div class="client-stat"><span>Processing</span><strong class="processing">${(d.processing || 0).toLocaleString()}</strong></div>
                        <div class="client-stat"><span>Failed</span><strong class="failed">${(d.failed || 0).toLocaleString()}</strong></div>
                        <div class="client-stat"><span>Callback</span><strong class="callback">${(d.callback || 0).toLocaleString()}</strong></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ============================================================================
        // TOKEN ANALYTICS FUNCTIONS
        // ============================================================================
        async function loadTokenAnalyticsClients() {
            const select = document.getElementById('token-client-select');
            if (select.options.length > 1) return;

            try {
                const response = await fetch('/api/clients');
                const data = await response.json();
                select.innerHTML = '<option value="all">All Clients</option>';
                data.client_ids.forEach(clientId => {
                    const option = document.createElement('option');
                    option.value = clientId;
                    option.textContent = clientId;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        async function analyzeTokens() {
            const startDate = document.getElementById('token-start-date').value;
            const endDate = document.getElementById('token-end-date').value;
            const clientId = document.getElementById('token-client-select').value;

            if (!startDate || !endDate) {
                showToast('Please select both dates', 'error');
                return;
            }

            const resultsDiv = document.getElementById('token-results');
            const noDataDiv = document.getElementById('token-no-data');

            resultsDiv.style.display = 'none';
            noDataDiv.style.display = 'flex';
            noDataDiv.innerHTML = '<div class="empty-icon"><div class="loading"></div></div><div class="empty-title">Loading...</div>';

            try {
                const params = new URLSearchParams({ start_date: startDate, end_date: endDate });
                if (clientId && clientId !== 'all') params.append('client_id', clientId);

                const response = await fetch(`/api/token-analytics?${params}`);
                const data = await response.json();

                if (!data.success) throw new Error(data.error || 'Failed to fetch token analytics');

                if (data.models.length === 0) {
                    noDataDiv.innerHTML = '<div class="empty-icon">üìä</div><div class="empty-title">No data</div><div class="empty-text">No token usage found for this period</div>';
                    return;
                }

                document.getElementById('token-total-tokens').textContent = data.totals.total_tokens.toLocaleString();
                document.getElementById('token-total-cost').textContent = '$' + data.totals.total_cost.toFixed(4);
                document.getElementById('token-requests').textContent = data.totals.request_count.toLocaleString();
                document.getElementById('token-models').textContent = data.models.length;

                createTokenChart(data.models);

                noDataDiv.style.display = 'none';
                resultsDiv.style.display = 'block';
                showToast('Token analytics loaded', 'success');
            } catch (error) {
                console.error('Token analytics error:', error);
                noDataDiv.innerHTML = `<div class="empty-icon">‚ùå</div><div class="empty-title">Error</div><div class="empty-text">${error.message}</div>`;
                showToast('Error loading token analytics', 'error');
            }
        }

        function createTokenChart(models) {
            const ctx = document.getElementById('tokenChart');
            if (charts.token) charts.token.destroy();

            const labels = models.map(m => m.model);
            const tokenData = models.map(m => m.total_tokens);

            // Vibrant color palette
            const vibrantColors = [
                'rgba(139, 92, 246, 0.55)',   // Purple
                'rgba(59, 130, 246, 0.55)',   // Blue
                'rgba(34, 197, 94, 0.55)',    // Green
                'rgba(245, 158, 11, 0.55)',   // Amber
                'rgba(239, 68, 68, 0.55)',    // Red
                'rgba(20, 184, 166, 0.55)',   // Teal
                'rgba(236, 72, 153, 0.55)',   // Pink
                'rgba(132, 204, 22, 0.55)',   // Lime
            ];
            const borderPalette = [
                'rgba(139, 92, 246, 1)',
                'rgba(59, 130, 246, 1)',
                'rgba(34, 197, 94, 1)',
                'rgba(245, 158, 11, 1)',
                'rgba(239, 68, 68, 1)',
                'rgba(20, 184, 166, 1)',
                'rgba(236, 72, 153, 1)',
                'rgba(132, 204, 22, 1)',
            ];
            const colors = models.map((_, i) => vibrantColors[i % vibrantColors.length]);
            const borderColors = models.map((_, i) => borderPalette[i % borderPalette.length]);

            charts.token = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Tokens',
                        data: tokenData,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        borderRadius: 6,
                        hoverBackgroundColor: borderColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 600, easing: 'easeOutQuart' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.98)',
                            borderColor: 'rgba(255, 255, 255, 0.12)',
                            borderWidth: 1,
                            padding: 14,
                            cornerRadius: 10,
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 11, family: "'IBM Plex Mono', monospace" },
                            displayColors: false,
                            callbacks: {
                                title: (items) => items[0].label,
                                label: ctx => {
                                    const model = models[ctx.dataIndex];
                                    return [
                                        `Total Tokens: ${ctx.parsed.y.toLocaleString()}`,
                                        '',
                                        `Input Cost:   $${model.input_cost.toFixed(4)}`,
                                        `Output Cost:  $${model.output_cost.toFixed(4)}`,
                                        `Total Cost:   $${model.total_cost.toFixed(4)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            border: { display: false },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.35)',
                                font: { size: 10, weight: '500' },
                                padding: 8,
                                callback: v => v >= 1000000 ? (v / 1000000).toFixed(1) + 'M' : v >= 1000 ? (v / 1000).toFixed(1) + 'K' : v
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.04)' }
                        },
                        x: {
                            border: { display: false },
                            ticks: { color: 'rgba(255, 255, 255, 0.35)', font: { size: 10, weight: '500' }, maxRotation: 45, padding: 4 },
                            grid: { display: false }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // ============================================================================
        // MODAL FUNCTIONS
        // ============================================================================
        async function openTicketModal(status) {
            const date = document.getElementById('overview-date').value;
            if (!date) return;

            try {
                const response = await fetch(`/api/tickets?date=${date}&status=${status}`);
                const data = await response.json();

                const modal = document.getElementById('ticketModal');
                const modalTitle = document.getElementById('modalTitle');
                const tableBody = document.getElementById('ticketsTableBody');

                modalTitle.className = 'modal-title-' + status;
                modalTitle.textContent = `${status.charAt(0).toUpperCase() + status.slice(1)} Tickets (${data.tickets.length})`;

                tableBody.innerHTML = '';
                data.tickets.forEach(ticket => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${ticket.ticket_id}</td>
                        <td>${ticket.client_id}</td>
                        <td><span class="status-badge ${status}">${status}</span></td>
                        <td>${new Date(ticket.created_at).toLocaleString()}</td>
                        <td>${ticket.auto_qa_status || '-'}</td>
                        <td>${ticket.request_status || '-'}</td>
                    `;
                    tableBody.appendChild(row);
                });

                modal.classList.add('is-visible');
                document.body.classList.add('modal-open');
            } catch (error) {
                console.error('Error loading tickets:', error);
                showToast('Error loading tickets', 'error');
            }
        }

        function closeTicketModal() {
            document.getElementById('ticketModal').classList.remove('is-visible');
            document.body.classList.remove('modal-open');
        }

        document.getElementById('ticketModal').addEventListener('click', function (e) {
            if (e.target === this) closeTicketModal();
        });

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('overview-date').value = today;

            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);

            document.getElementById('range-end-date').valueAsDate = endDate;
            document.getElementById('range-start-date').valueAsDate = startDate;

            document.getElementById('overview-date').addEventListener('change', loadOverviewData);

            // Restore saved tab or default to overview
            const savedTab = localStorage.getItem('activeTab') || 'overview';
            restoreTab(savedTab);
        });

        // Function to restore tab without requiring event
        function restoreTab(tabName) {
            document.querySelectorAll('.tab-panel').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));

            const tabPanel = document.getElementById(tabName + '-tab');
            if (tabPanel) {
                tabPanel.classList.add('active');
            } else {
                // Fallback to overview if saved tab doesn't exist
                document.getElementById('overview-tab').classList.add('active');
                tabName = 'overview';
            }

            // Activate the corresponding nav button
            const navButtons = document.querySelectorAll('.nav-item');
            const tabIndex = { 'overview': 0, 'client': 1, 'date-range': 2, 'token-analytics': 3 };
            if (navButtons[tabIndex[tabName]]) {
                navButtons[tabIndex[tabName]].classList.add('active');
            }

            // Load data for the restored tab
            if (tabName === 'overview') loadOverviewData();
            else if (tabName === 'client') loadClientList();
            else if (tabName === 'date-range') loadClientListForRange();
            else if (tabName === 'token-analytics') {
                loadTokenAnalyticsClients();
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 7);
                document.getElementById('token-end-date').valueAsDate = endDate;
                document.getElementById('token-start-date').valueAsDate = startDate;
            }
        }
    </script>
</body>

</html>