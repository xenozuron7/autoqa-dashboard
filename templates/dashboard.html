<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoQA Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-icon">üéØ</div>
                <div class="header-text">
                    <h1>AutoQA Dashboard</h1>
                    <p>Real-time ticket monitoring and analytics</p>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('overview')">üìä Overview Dashboard</button>
            <button class="tab-btn" onclick="switchTab('client')">üë§ Client Dashboard</button>
            <button class="tab-btn" onclick="switchTab('range')">üìÖ Date Range Analysis</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-strip">
                    <div class="control-group">
                        <label class="control-label">Select Date</label>
                        <input type="date" id="date-picker" class="date-input" onchange="loadData()">
                    </div>
                    
                    <div class="refresh-toggle">
                        <label>
                            <input type="checkbox" id="auto-refresh-toggle" class="checkbox-custom" onchange="toggleAutoRefresh()">
                            Auto Refresh
                        </label>
                        <span class="control-label">Every</span>
                        <input type="number" id="refresh-interval" min="5" max="300" value="30" class="refresh-input" disabled onchange="updateRefreshInterval()">
                        <span class="control-label">sec</span>
                    </div>
                    
                    <button class="btn btn-primary" onclick="loadData()">
                        <span id="load-btn-text">Reload</span>
                        <div class="loading" id="load-spinner" style="display: none;"></div>
                    </button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card completed">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-label">Completed Tickets</div>
                    <div class="stat-value" id="completed-count">0</div>
                    <div class="stat-subtitle">Successfully resolved</div>
                </div>
                
                <div class="stat-card processing">
                    <div class="stat-icon">‚öôÔ∏è</div>
                    <div class="stat-label">Processing Tickets</div>
                    <div class="stat-value" id="processing-count">0</div>
                    <div class="stat-subtitle">Currently in progress</div>
                </div>
                
                <div class="stat-card failed">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-label">Failed Tickets</div>
                    <div class="stat-value" id="failed-count">0</div>
                    <div class="stat-subtitle">Requires attention</div>
                </div>
                
                <div class="stat-card callback">
                    <div class="stat-icon">üìû</div>
                    <div class="stat-label">Callback Required</div>
                    <div class="stat-value" id="callback-count">0</div>
                    <div class="stat-subtitle">Awaiting callback</div>
                </div>
            </div>

            <!-- No Data Message -->
            <div class="no-data" id="no-data-message" style="display: block;">
                <div class="no-data-icon">üìä</div>
                <div class="no-data-text">No data available for the selected date</div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section" id="charts-section" style="display: none;">
                <div class="chart-card completed" onclick="openModal('completed')">
                    <div class="chart-header">
                        <div class="chart-icon">‚úÖ</div>
                        <h3 class="chart-title">Completed Tickets</h3>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="completed-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card processing" onclick="openModal('processing')">
                    <div class="chart-header">
                        <div class="chart-icon">‚öôÔ∏è</div>
                        <h3 class="chart-title">Processing Tickets</h3>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="processing-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card failed" onclick="openModal('failed')">
                    <div class="chart-header">
                        <div class="chart-icon">‚ùå</div>
                        <h3 class="chart-title">Failed Tickets</h3>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="failed-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card callback" onclick="openModal('callback')">
                    <div class="chart-header">
                        <div class="chart-icon">üìû</div>
                        <h3 class="chart-title">Callback Required</h3>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="callback-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Dashboard Tab -->
        <div id="client-tab" class="tab-content">
            <div class="client-selector">
                <label for="client-dropdown">Select Client ID:</label>
                <select id="client-dropdown" onchange="loadClientData()">
                    <option value="">-- Select a Client --</option>
                </select>
            </div>

            <div id="client-stats" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card completed">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-label">Completed Tickets (Past 7 Days)</div>
                        <div class="stat-value" id="client-completed-count">0</div>
                    </div>
                    
                    <div class="stat-card processing">
                        <div class="stat-icon">‚öôÔ∏è</div>
                        <div class="stat-label">Processing Tickets (Past 7 Days)</div>
                        <div class="stat-value" id="client-processing-count">0</div>
                    </div>
                    
                    <div class="stat-card failed">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-label">Failed Tickets (Past 7 Days)</div>
                        <div class="stat-value" id="client-failed-count">0</div>
                    </div>
                    
                    <div class="stat-card callback">
                        <div class="stat-icon">üìû</div>
                        <div class="stat-label">Callback Required (Past 7 Days)</div>
                        <div class="stat-value" id="client-callback-count">0</div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-card completed">
                        <div class="chart-header">
                            <div class="chart-icon">‚úÖ</div>
                            <h3 class="chart-title">Completed Tickets (Past 7 Days)</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="client-completed-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card processing">
                        <div class="chart-header">
                            <div class="chart-icon">‚öôÔ∏è</div>
                            <h3 class="chart-title">Processing Tickets (Past 7 Days)</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="client-processing-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card failed">
                        <div class="chart-header">
                            <div class="chart-icon">‚ùå</div>
                            <h3 class="chart-title">Failed Tickets (Past 7 Days)</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="client-failed-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card callback">
                        <div class="chart-header">
                            <div class="chart-icon">üìû</div>
                            <h3 class="chart-title">Callback Required (Past 7 Days)</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="client-callback-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="no-data" id="client-no-data" style="display: block;">
                <div class="no-data-icon">üë§</div>
                <div class="no-data-text">No tickets found for this client</div>
            </div>
        </div>

        <!-- Date Range Analysis Tab -->
        <div id="range-tab" class="tab-content">
            <div class="control-panel">
                <div class="control-strip">
                    <div class="control-group">
                        <label class="control-label">Start Date</label>
                        <input type="date" id="range-start-date" class="date-input">
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">End Date</label>
                        <input type="date" id="range-end-date" class="date-input">
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Filter by Clients (Optional)</label>
                        <div class="multi-select-wrapper">
                            <button class="multi-select-trigger" id="client-select-trigger" onclick="toggleClientDropdown(event)">
                                <span id="selected-clients-text">All Clients</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="multi-select-dropdown" id="client-dropdown-menu" style="display: none;">
                                <div class="multi-select-search">
                                    <input type="text" id="client-search" placeholder="Search clients..." onkeyup="filterClients()">
                                </div>
                                <div class="multi-select-options" id="client-options">
                                    <!-- Options populated dynamically -->
                                </div>
                                <div class="multi-select-actions">
                                    <button class="btn-small" onclick="selectAllClients()">Select All</button>
                                    <button class="btn-small" onclick="clearAllClients()">Clear All</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="loadRangeData()">
                        <span id="range-load-btn-text">Analyze</span>
                        <div class="loading" id="range-load-spinner" style="display: none;"></div>
                    </button>
                </div>
            </div>

            <div class="stats-grid" id="range-stats" style="display: none;">
                <div class="stat-card completed">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-label">Total Completed Tickets</div>
                    <div class="stat-value" id="range-completed-count">0</div>
                    <div class="stat-subtitle" id="range-completed-subtitle">In selected range</div>
                </div>
                
                <div class="stat-card processing">
                    <div class="stat-icon">‚öôÔ∏è</div>
                    <div class="stat-label">Total Processing Tickets</div>
                    <div class="stat-value" id="range-processing-count">0</div>
                    <div class="stat-subtitle" id="range-processing-subtitle">In selected range</div>
                </div>
                
                <div class="stat-card failed">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-label">Total Failed Tickets</div>
                    <div class="stat-value" id="range-failed-count">0</div>
                    <div class="stat-subtitle" id="range-failed-subtitle">In selected range</div>
                </div>
                
                <div class="stat-card callback">
                    <div class="stat-icon">üìû</div>
                    <div class="stat-label">Total Callback Required</div>
                    <div class="stat-value" id="range-callback-count">0</div>
                    <div class="stat-subtitle" id="range-callback-subtitle">In selected range</div>
                </div>
            </div>

            <div class="charts-section" id="range-charts-section" style="display: none;">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-icon">üìà</div>
                        <h3 class="chart-title">Daily Ticket Trend (All Statuses)</h3>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="range-combined-chart"></canvas>
                    </div>
                </div>
            </div>

            <div id="range-client-breakdown" style="display: none;">
                <h2 class="section-title">Client Breakdown</h2>
                <div class="client-breakdown-grid" id="client-breakdown-cards">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <div class="no-data" id="range-no-data" style="display: block;">
                <div class="no-data-icon">üìÖ</div>
                <div class="no-data-text">Select a date range to analyze ticket data</div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Tickets</h2>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modal-body">
                <div class="loading" id="modal-loading"></div>
                <table class="tickets-table" id="modal-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Client ID</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Auto QA Status</th>
                            <th>Request Status</th>
                        </tr>
                    </thead>
                    <tbody id="modal-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

   <script>
        const datalabelsPlugin = ChartDataLabels;
        let currentDate = new Date().toISOString().split('T')[0];
        let chartInstances = {};
        let isFirstLoad = true;
        let refreshInterval = null;
        let clientCharts = {};
        let rangeChartInstance = null;
        let selectedClients = new Set();
        let activeCounterAnimations = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-picker').value = today;
            document.getElementById('date-picker').max = today;
            
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            document.getElementById('range-start-date').value = sevenDaysAgo.toISOString().split('T')[0];
            document.getElementById('range-end-date').value = today;
            document.getElementById('range-start-date').max = today;
            document.getElementById('range-end-date').max = today;
            
            loadAllClients();
            restoreState();
            
            // Auto-load data on page load with slight delay
            setTimeout(() => {
                loadData();
            }, 100);
        });

        // Click outside to close dropdown
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('client-dropdown-menu');
            const trigger = document.getElementById('client-select-trigger');
            
            if (dropdown && trigger && !trigger.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.style.display = 'none';
                trigger.classList.remove('open');
            }
        });

        function toggleClientDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('client-dropdown-menu');
            const trigger = document.getElementById('client-select-trigger');
            
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                trigger.classList.add('open');
            } else {
                dropdown.style.display = 'none';
                trigger.classList.remove('open');
            }
        }

        function filterClients() {
            const searchTerm = document.getElementById('client-search').value.toLowerCase();
            const options = document.querySelectorAll('.multi-select-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function selectAllClients() {
            const checkboxes = document.querySelectorAll('#client-options input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                selectedClients.add(cb.value);
            });
            updateSelectedClientsText();
        }

        function clearAllClients() {
            const checkboxes = document.querySelectorAll('#client-options input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            selectedClients.clear();
            updateSelectedClientsText();
        }

        function handleClientSelection(checkbox) {
            if (checkbox.checked) {
                selectedClients.add(checkbox.value);
            } else {
                selectedClients.delete(checkbox.value);
            }
            updateSelectedClientsText();
        }

        function updateSelectedClientsText() {
            const text = document.getElementById('selected-clients-text');
            const count = selectedClients.size;
            
            if (count === 0) {
                text.textContent = 'All Clients';
            } else if (count === 1) {
                text.textContent = Array.from(selectedClients)[0];
            } else {
                text.textContent = `${count} clients selected`;
            }
        }

        async function loadRangeClients() {
            try {
                const response = await fetch('/api/all-clients');
                const data = await response.json();
                
                const optionsContainer = document.getElementById('client-options');
                optionsContainer.innerHTML = data.client_ids.map(clientId => `
                    <label class="multi-select-option">
                        <input type="checkbox" value="${clientId}" onchange="handleClientSelection(this)">
                        <span>${clientId}</span>
                    </label>
                `).join('');
                
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        async function loadRangeData() {
            const startDate = document.getElementById('range-start-date').value;
            const endDate = document.getElementById('range-end-date').value;
            
            if (!startDate || !endDate) {
                showToast('Please select both start and end dates', 'error');
                return;
            }
            
            const loadBtn = document.getElementById('range-load-btn-text');
            const spinner = document.getElementById('range-load-spinner');
            
            loadBtn.style.display = 'none';
            spinner.style.display = 'inline-block';
            
            try {
                let url = `/api/ticket-data-range?start_date=${startDate}&end_date=${endDate}`;
                
                if (selectedClients.size > 0) {
                    url += `&client_ids=${Array.from(selectedClients).join(',')}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load data');
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Invalid response from server');
                }
                
                document.getElementById('range-no-data').style.display = 'none';
                document.getElementById('range-stats').style.display = 'grid';
                
                const subtitle = selectedClients.size > 0 
                    ? `${selectedClients.size} client(s), ${data.total_days} days`
                    : `All clients, ${data.total_days} days`;
                
                document.getElementById('range-completed-subtitle').textContent = subtitle;
                document.getElementById('range-processing-subtitle').textContent = subtitle;
                document.getElementById('range-failed-subtitle').textContent = subtitle;
                document.getElementById('range-callback-subtitle').textContent = subtitle;
                
                animateCounter('range-completed-count', data.total_stats.completed);
                animateCounter('range-processing-count', data.total_stats.processing);
                animateCounter('range-failed-count', data.total_stats.failed);
                animateCounter('range-callback-count', data.total_stats.callback);
                
                document.getElementById('range-charts-section').style.display = 'flex';
                updateRangeChart(data.daily_breakdown);
                
                if (data.client_breakdown) {
                    displayClientBreakdown(data.client_breakdown);
                } else {
                    document.getElementById('range-client-breakdown').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading range data:', error);
                showToast(error.message || 'Failed to load data', 'error');
                document.getElementById('range-no-data').style.display = 'block';
                document.getElementById('range-stats').style.display = 'none';
                document.getElementById('range-charts-section').style.display = 'none';
                document.getElementById('range-client-breakdown').style.display = 'none';
            } finally {
                loadBtn.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        function updateRangeChart(dailyData) {
            const canvas = document.getElementById('range-combined-chart');
            
            if (rangeChartInstance) {
                rangeChartInstance.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            
            rangeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyData.dates,
                    datasets: [
                        {
                            label: 'Completed',
                            data: dailyData.completed,
                            backgroundColor: '#10b981',
                            borderRadius: 8,
                            borderSkipped: false,
                            maxBarThickness: 60,
                            hoverBackgroundColor: '#059669'
                        },
                        {
                            label: 'Processing',
                            data: dailyData.processing,
                            backgroundColor: '#f59e0b',
                            borderRadius: 8,
                            borderSkipped: false,
                            maxBarThickness: 60,
                            hoverBackgroundColor: '#d97706'
                        },
                        {
                            label: 'Failed',
                            data: dailyData.failed,
                            backgroundColor: '#dc2626',
                            borderRadius: 8,
                            borderSkipped: false,
                            maxBarThickness: 60,
                            hoverBackgroundColor: '#b91c1c'
                        },
                        {
                            label: 'Callback',
                            data: dailyData.callback,
                            backgroundColor: '#8b5cf6',
                            borderRadius: 8,
                            borderSkipped: false,
                            maxBarThickness: 60,
                            hoverBackgroundColor: '#7c3aed'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            formatter: (value) => value > 0 ? value.toLocaleString() : '',
                            color: '#374151',
                            font: { weight: 'bold', size: 11 }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 },
                            grace: '15%',
                            grid: { color: '#f3f4f6' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart',
                        animateScale: true,
                        animateRotate: true
                    },
                    interaction: {
                        mode: 'point',
                        intersect: true
                    },
                    elements: {
                        bar: {
                            borderWidth: 0,
                            hoverBorderWidth: 2,
                            hoverBorderColor: 'rgba(0, 0, 0, 0.2)'
                        }
                    }
                },
                plugins: [datalabelsPlugin]
            });
        }

        function displayClientBreakdown(clientData) {
            const container = document.getElementById('client-breakdown-cards');
            const section = document.getElementById('range-client-breakdown');
            
            section.style.display = 'block';
            
            container.innerHTML = Object.entries(clientData).map(([clientId, stats]) => `
                <div class="client-card">
                    <div class="client-card-header">${clientId}</div>
                    <div class="client-card-stats">
                        <div class="client-stat-row">
                            <span class="client-stat-label">Completed:</span>
                            <span class="client-stat-value completed">${stats.completed.toLocaleString()}</span>
                        </div>
                        <div class="client-stat-row">
                            <span class="client-stat-label">Processing:</span>
                            <span class="client-stat-value processing">${stats.processing.toLocaleString()}</span>
                        </div>
                        <div class="client-stat-row">
                            <span class="client-stat-label">Failed:</span>
                            <span class="client-stat-value failed">${stats.failed.toLocaleString()}</span>
                        </div>
                        <div class="client-stat-row">
                            <span class="client-stat-label">Callback:</span>
                            <span class="client-stat-value callback">${stats.callback.toLocaleString()}</span>
                        </div>
                        <div class="client-stat-row" style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px;">
                            <span class="client-stat-label" style="font-weight: 600;">Total:</span>
                            <span class="client-stat-value" style="font-weight: 700;">${stats.total.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'overview') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('overview-tab').classList.add('active');
            } else if (tab === 'client') {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('client-tab').classList.add('active');
            } else if (tab === 'range') {
                document.querySelectorAll('.tab-btn')[2].classList.add('active');
                document.getElementById('range-tab').classList.add('active');
                
                if (!document.getElementById('client-options').children.length) {
                    loadRangeClients();
                }
            }
            
            saveState();
        }

        // Load data
        async function loadData() {
            const selectedDate = document.getElementById('date-picker').value;
            currentDate = selectedDate;
            
            const loadBtn = document.getElementById('load-btn-text');
            const spinner = document.getElementById('load-spinner');
            
            loadBtn.style.display = 'none';
            spinner.style.display = 'inline-block';

            try {
                const response = await fetch(`/api/ticket-data?date=${currentDate}`);
                const data = await response.json();

                if (data.message === 'No data available') {
                    document.getElementById('no-data-message').style.display = 'block';
                    document.getElementById('charts-section').style.display = 'none';
                    updateStatCards(0, 0, 0, 0);
                } else {
                    document.getElementById('no-data-message').style.display = 'none';
                    document.getElementById('charts-section').style.display = 'flex';
                    
                    const completedTotal = data.completed.reduce((a, b) => a + b, 0);
                    const processingTotal = data.processing.reduce((a, b) => a + b, 0);
                    const failedTotal = data.failed.reduce((a, b) => a + b, 0);
                    const callbackTotal = data.callback.reduce((a, b) => a + b, 0);
                    
                    updateStatCards(completedTotal, processingTotal, failedTotal, callbackTotal);
                    updateCharts(data);
                }
                
                isFirstLoad = false;
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Failed to load data', 'error');
            } finally {
                loadBtn.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        function updateStatCards(completed, processing, failed, callback) {
            animateCounter('completed-count', completed);
            animateCounter('processing-count', processing);
            animateCounter('failed-count', failed);
            animateCounter('callback-count', callback);
        }

        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Clear any existing animation for this element
            if (activeCounterAnimations[elementId]) {
                clearInterval(activeCounterAnimations[elementId]);
                delete activeCounterAnimations[elementId];
            }
            
            const duration = isFirstLoad ? 1000 : 500;
            const startValue = parseInt(element.textContent.replace(/,/g, '')) || 0;
            
            // If values are the same, just update and return
            if (startValue === targetValue) {
                element.textContent = targetValue.toLocaleString();
                return;
            }
            
            const increment = (targetValue - startValue) / (duration / 16);
            let currentValue = startValue;

            const timer = setInterval(() => {
                currentValue += increment;
                if ((increment > 0 && currentValue >= targetValue) || (increment < 0 && currentValue <= targetValue)) {
                    element.textContent = targetValue.toLocaleString();
                    clearInterval(timer);
                    delete activeCounterAnimations[elementId];
                } else {
                    element.textContent = Math.round(currentValue).toLocaleString();
                }
            }, 16);
            
            activeCounterAnimations[elementId] = timer;
        }

        function updateCharts(data) {
            createOrUpdateChart('completed', data.client_ids, data.completed, '#10b981');
            createOrUpdateChart('processing', data.client_ids, data.processing, '#f59e0b');
            createOrUpdateChart('failed', data.client_ids, data.failed, '#dc2626');
            createOrUpdateChart('callback', data.client_ids, data.callback, '#8b5cf6');
        }

        function createOrUpdateChart(type, labels, data, color) {
            const canvasId = `${type}-chart`;
            const canvas = document.getElementById(canvasId);
            
            if (chartInstances[type]) {
                chartInstances[type].destroy();
            }
            
            const hoverColors = {
                '#10b981': '#059669',
                '#f59e0b': '#d97706',
                '#dc2626': '#b91c1c',
                '#8b5cf6': '#7c3aed'
            };
            
            const ctx = canvas.getContext('2d');
            chartInstances[type] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tickets',
                        data: data,
                        backgroundColor: color,
                        hoverBackgroundColor: hoverColors[color],
                        borderRadius: 8,
                        borderSkipped: false,
                        maxBarThickness: 80
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            openModal(type);
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            formatter: (value) => value > 0 ? value.toLocaleString() : '',
                            color: '#374151',
                            font: { weight: 'bold', size: 12 }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 },
                            grace: '15%',
                            grid: { color: '#f3f4f6' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    animation: {
                        duration: isFirstLoad ? 1500 : 500,
                        easing: 'easeOutQuart',
                        animateScale: true,
                        animateRotate: true
                    },
                    interaction: {
                        mode: 'point',
                        intersect: true
                    },
                    elements: {
                        bar: {
                            borderWidth: 0,
                            hoverBorderWidth: 2,
                            hoverBorderColor: 'rgba(0, 0, 0, 0.2)'
                        }
                    }
                },
                plugins: [datalabelsPlugin]
            });
        }

        async function loadAllClients() {
            try {
                const response = await fetch('/api/all-clients');
                const data = await response.json();
                
                const dropdown = document.getElementById('client-dropdown');
                data.client_ids.forEach(clientId => {
                    const option = document.createElement('option');
                    option.value = clientId;
                    option.textContent = clientId;
                    dropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        async function loadClientData() {
            const clientId = document.getElementById('client-dropdown').value;
            
            if (!clientId) {
                document.getElementById('client-no-data').style.display = 'block';
                document.getElementById('client-stats').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/client-tickets-7days?client_id=${clientId}`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('client-no-data').style.display = 'none';
                    document.getElementById('client-stats').style.display = 'block';

                    animateCounter('client-completed-count', data.all_time_stats.completed);
                    animateCounter('client-processing-count', data.all_time_stats.processing);
                    animateCounter('client-failed-count', data.all_time_stats.failed);
                    animateCounter('client-callback-count', data.all_time_stats.callback);

                    updateClientCharts(data.seven_day_data);
                }
            } catch (error) {
                console.error('Error loading client data:', error);
            }
        }

        function updateClientCharts(sevenDayData) {
            const types = ['completed', 'processing', 'failed', 'callback'];
            const colors = {
                completed: '#10b981',
                processing: '#f59e0b',
                failed: '#dc2626',
                callback: '#8b5cf6'
            };
            
            const hoverColors = {
                completed: '#059669',
                processing: '#d97706',
                failed: '#b91c1c',
                callback: '#7c3aed'
            };

            types.forEach(type => {
                const canvasId = `client-${type}-chart`;
                const canvas = document.getElementById(canvasId);
                
                if (clientCharts[type]) {
                    clientCharts[type].destroy();
                }
                
                const ctx = canvas.getContext('2d');
                clientCharts[type] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sevenDayData.dates,
                        datasets: [{
                            label: type.charAt(0).toUpperCase() + type.slice(1),
                            data: sevenDayData[type],
                            backgroundColor: colors[type],
                            hoverBackgroundColor: hoverColors[type],
                            borderRadius: 8,
                            borderSkipped: false,
                            maxBarThickness: 80
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onHover: (event, activeElements) => {
                            event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                        },
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                offset: 4,
                                formatter: (value) => value > 0 ? value.toLocaleString() : '',
                                color: '#374151',
                                font: { weight: 'bold', size: 12 }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { precision: 0 },
                                grace: '15%',
                                grid: { color: '#f3f4f6' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart',
                            animateScale: true,
                            animateRotate: true
                        },
                        interaction: {
                            mode: 'point',
                            intersect: true
                        },
                        elements: {
                            bar: {
                                borderWidth: 0,
                                hoverBorderWidth: 2,
                                hoverBorderColor: 'rgba(0, 0, 0, 0.2)'
                            }
                        }
                    },
                    plugins: [datalabelsPlugin]
                });
            });
        }

        async function openModal(status) {
            const modal = document.getElementById('ticketModal');
            const modalTitle = document.getElementById('modal-title');
            const modalLoading = document.getElementById('modal-loading');
            const modalTable = document.getElementById('modal-table');
            const tableBody = document.getElementById('modal-table-body');

            const statusTitles = {
                'completed': 'Completed Tickets',
                'processing': 'Processing Tickets',
                'failed': 'Failed Tickets',
                'callback': 'Callback Required Tickets'
            };

            const statusClasses = {
                'completed': 'modal-title-completed',
                'processing': 'modal-title-processing',
                'failed': 'modal-title-failed',
                'callback': 'modal-title-callback'
            };

            modalTitle.textContent = statusTitles[status] || 'Tickets';
            modalTitle.className = statusClasses[status] || '';
            modal.classList.add('is-visible');
            document.body.classList.add('modal-open');
            modalLoading.style.display = 'block';
            modalTable.style.display = 'none';

            try {
                const response = await fetch(`/api/detailed-tickets?date=${currentDate}&status=${status}`);
                const data = await response.json();

                if (data.tickets && data.tickets.length > 0) {
                    tableBody.innerHTML = data.tickets.map(ticket => `
                        <tr>
                            <td>${ticket.ticket_id}</td>
                            <td>${ticket.client_id}</td>
                            <td><span class="status-badge ${status}">${ticket.status}</span></td>
                            <td>${ticket.created_at}</td>
                            <td>${ticket.auto_qa_status}</td>
                            <td>${ticket.request_status}</td>
                        </tr>
                    `).join('');
                    modalTable.style.display = 'table';
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No tickets found</td></tr>';
                    modalTable.style.display = 'table';
                }
            } catch (error) {
                console.error('Error loading tickets:', error);
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc2626;">Error loading tickets</td></tr>';
                modalTable.style.display = 'table';
            } finally {
                modalLoading.style.display = 'none';
            }
        }

        function closeModal() {
            const modal = document.getElementById('ticketModal');
            modal.classList.remove('is-visible');
            document.body.classList.remove('modal-open');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('ticketModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function toggleAutoRefresh() {
            const toggle = document.getElementById('auto-refresh-toggle');
            const intervalInput = document.getElementById('refresh-interval');
            
            if (toggle.checked) {
                intervalInput.disabled = false;
                const seconds = parseInt(intervalInput.value);
                startAutoRefresh(seconds);
            } else {
                intervalInput.disabled = true;
                stopAutoRefresh();
            }
            
            saveState();
        }

        function updateRefreshInterval() {
            const toggle = document.getElementById('auto-refresh-toggle');
            if (toggle.checked) {
                const seconds = parseInt(document.getElementById('refresh-interval').value);
                startAutoRefresh(seconds);
            }
            saveState();
        }

        let refreshIntervalId = 0;

        function startAutoRefresh(seconds) {
            stopAutoRefresh();
            
            refreshIntervalId++;
            const currentId = refreshIntervalId;
            
            refreshInterval = setInterval(() => {
                if (currentId !== refreshIntervalId) {
                    clearInterval(refreshInterval);
                    return;
                }
                
                isFirstLoad = false;
                loadData();
                
                const activeTab = document.querySelector('.tab-btn.active').textContent;
                if (activeTab.includes('Client')) {
                    const clientId = document.getElementById('client-dropdown').value;
                    if (clientId) {
                        loadClientData();
                    }
                }
            }, seconds * 1000);
            
            showToast('Auto-refresh enabled', 'success');
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            refreshIntervalId++;
        }

        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
            // Clear all counter animations
            Object.values(activeCounterAnimations).forEach(timer => clearInterval(timer));
        });

        function saveState() {
            const activeBtn = document.querySelector('.tab-btn.active');
            let activeTab = 'overview';
            if (activeBtn) {
                if (activeBtn.textContent.includes('Client')) activeTab = 'client';
                else if (activeBtn.textContent.includes('Range')) activeTab = 'range';
            }
            
            const state = {
                activeTab: activeTab,
                selectedDate: document.getElementById('date-picker').value,
                selectedClient: document.getElementById('client-dropdown').value,
                autoRefreshEnabled: document.getElementById('auto-refresh-toggle').checked,
                refreshInterval: document.getElementById('refresh-interval').value,
                rangeStartDate: document.getElementById('range-start-date')?.value,
                rangeEndDate: document.getElementById('range-end-date')?.value,
                selectedClients: Array.from(selectedClients)
            };
            localStorage.setItem('dashboardState', JSON.stringify(state));
        }

        function restoreState() {
            try {
                const savedState = localStorage.getItem('dashboardState');
                if (!savedState) return;
                
                const state = JSON.parse(savedState);
                
                if (state.selectedDate) {
                    currentDate = state.selectedDate;
                    document.getElementById('date-picker').value = state.selectedDate;
                }
                
                if (state.autoRefreshEnabled) {
                    document.getElementById('auto-refresh-toggle').checked = true;
                    document.getElementById('refresh-interval').disabled = false;
                }
                
                if (state.refreshInterval) {
                    document.getElementById('refresh-interval').value = state.refreshInterval;
                }
                
                if (state.activeTab === 'client') {
                    setTimeout(() => {
                        switchTab('client');
                        if (state.selectedClient) {
                            document.getElementById('client-dropdown').value = state.selectedClient;
                            loadClientData();
                        }
                    }, 500);
                } else if (state.activeTab === 'range') {
                    setTimeout(() => {
                        switchTab('range');
                        if (state.rangeStartDate) {
                            document.getElementById('range-start-date').value = state.rangeStartDate;
                        }
                        if (state.rangeEndDate) {
                            document.getElementById('range-end-date').value = state.rangeEndDate;
                        }
                        if (state.selectedClients && Array.isArray(state.selectedClients)) {
                            selectedClients = new Set(state.selectedClients);
                            updateSelectedClientsText();
                        }
                    }, 500);
                }
                
                if (state.autoRefreshEnabled && state.refreshInterval) {
                    const interval = parseInt(state.refreshInterval);
                    if (!isNaN(interval)) {
                        startAutoRefresh(interval);
                    }
                }
                
            } catch (e) {
                console.error('Error restoring state:', e);
                localStorage.removeItem('dashboardState');
            }
        }
    </script>
</body>
</html>