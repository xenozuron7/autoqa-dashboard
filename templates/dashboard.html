<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto QA Analytics Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="bg-pattern"></div>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <div class="header-icon">üìä</div>
                <div class="header-text">
                    <h1>Auto QA Analytics Dashboard</h1>
                    <p>Real-time ticket monitoring and analysis</p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('overview')">üìä Overview</button>
            <button class="tab-btn" onclick="switchTab('client')">üë§ Client Dashboard</button>
            <button class="tab-btn" onclick="switchTab('date-range')">üìÖ Date Range Analysis</button>
            <button class="tab-btn" onclick="switchTab('token-analytics')">üéØ Token Analytics</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-strip">
                    <div class="control-group">
                        <label class="control-label">Select Date</label>
                        <input type="date" id="overview-date" class="date-input">
                    </div>

                    <div class="refresh-toggle">
                        <label>
                            <input type="checkbox" id="auto-refresh-toggle" class="checkbox-custom">
                            <span>Auto Refresh</span>
                        </label>
                        <span style="color: #6b7280; font-weight: 600;">Every</span>
                        <input type="number" id="refresh-interval" class="refresh-input" value="30" min="5" max="300" disabled>
                        <span style="color: #6b7280; font-weight: 600;">sec</span>
                    </div>

                    <button class="btn btn-secondary" onclick="manualReload()">
                        <span>üîÑ</span>
                        Reload
                    </button>
                </div>
            </div>

            <!-- Date Banner -->
            <div class="date-banner" id="overview-date-banner">
                <div class="date-banner-icon">üìÖ</div>
                <div class="date-banner-text" id="overview-date-text">Loading...</div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card completed" onclick="openTicketModal('completed')">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-label">Completed Tickets</div>
                    <div class="stat-value" id="completed-count">0</div>
                    <div class="stat-subtitle">Successfully resolved</div>
                </div>

                <div class="stat-card processing" onclick="openTicketModal('processing')">
                    <div class="stat-icon">‚öôÔ∏è</div>
                    <div class="stat-label">Processing Tickets</div>
                    <div class="stat-value" id="processing-count">0</div>
                    <div class="stat-subtitle">Currently in progress</div>
                </div>

                <div class="stat-card failed" onclick="openTicketModal('failed')">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-label">Failed Tickets</div>
                    <div class="stat-value" id="failed-count">0</div>
                    <div class="stat-subtitle">Requires attention</div>
                </div>

                <div class="stat-card callback" onclick="openTicketModal('callback')">
                    <div class="stat-icon">üìû</div>
                    <div class="stat-label">Callback Required</div>
                    <div class="stat-value" id="callback-count">0</div>
                    <div class="stat-subtitle">Awaiting callback</div>
                </div>
            </div>

            <!-- No Data Message -->
            <div id="overview-no-data" class="no-data" style="display: none;">
                <div class="no-data-icon">üì≠</div>
                <div class="no-data-text">No data available for the selected date</div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section" id="overview-charts" style="display: none;">
                <div class="chart-card completed">
                    <div class="chart-header">
                        <div class="chart-icon">‚úÖ</div>
                        <h3 class="chart-title">Completed Tickets</h3>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="completedChart"></canvas>
                    </div>
                </div>

                <div class="chart-card processing">
                    <div class="chart-header">
                        <div class="chart-icon">‚öôÔ∏è</div>
                        <h3 class="chart-title">Processing Tickets</h3>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="processingChart"></canvas>
                    </div>
                </div>

                <div class="chart-card failed">
                    <div class="chart-header">
                        <div class="chart-icon">‚ùå</div>
                        <h3 class="chart-title">Failed Tickets</h3>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="failedChart"></canvas>
                    </div>
                </div>

                <div class="chart-card callback">
                    <div class="chart-header">
                        <div class="chart-icon">üìû</div>
                        <h3 class="chart-title">Callback Required</h3>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="callbackChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Dashboard Tab -->
        <div id="client-tab" class="tab-content">
            <div class="client-selector">
                <label for="client-id-select">Select Client ID:</label>
                <select id="client-id-select" onchange="loadClientData()">
                    <option value="">-- Select a Client --</option>
                </select>
            </div>

            <div id="client-data-container" style="display: none;">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card completed">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-label">Completed Tickets (Past 7 Days)</div>
                        <div class="stat-value" id="client-completed-count">0</div>
                    </div>

                    <div class="stat-card processing">
                        <div class="stat-icon">‚öôÔ∏è</div>
                        <div class="stat-label">Processing Tickets (Past 7 Days)</div>
                        <div class="stat-value" id="client-processing-count">0</div>
                    </div>

                    <div class="stat-card failed">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-label">Failed Tickets (Past 7 Days)</div>
                        <div class="stat-value" id="client-failed-count">0</div>
                    </div>

                    <div class="stat-card callback">
                        <div class="stat-icon">üìû</div>
                        <div class="stat-label">Callback Required (Past 7 Days)</div>
                        <div class="stat-value" id="client-callback-count">0</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-section">
                    <div class="chart-card completed">
                        <div class="chart-header">
                            <div class="chart-icon">‚úÖ</div>
                            <h3 class="chart-title">Completed Tickets (Past 7 Days)</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="clientCompletedChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card processing">
                        <div class="chart-header">
                            <div class="chart-icon">‚öôÔ∏è</div>
                            <h3 class="chart-title">Processing Tickets (Past 7 Days)</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="clientProcessingChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card failed">
                        <div class="chart-header">
                            <div class="chart-icon">‚ùå</div>
                            <h3 class="chart-title">Failed Tickets (Past 7 Days)</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="clientFailedChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card callback">
                        <div class="chart-header">
                            <div class="chart-icon">üìû</div>
                            <h3 class="chart-title">Callback Required (Past 7 Days)</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="clientCallbackChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="client-no-data" class="no-data">
                <div class="no-data-icon">üë§</div>
                <div class="no-data-text">No tickets found for this client</div>
            </div>
        </div>

        <!-- Date Range Analysis Tab -->
        <div id="date-range-tab" class="tab-content">
            <div class="control-panel">
                <div class="control-strip">
                    <div class="control-group">
                        <label class="control-label">Start Date</label>
                        <input type="date" id="range-start-date" class="date-input">
                    </div>

                    <div class="control-group">
                        <label class="control-label">End Date</label>
                        <input type="date" id="range-end-date" class="date-input">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Filter by Clients (Optional)</label>
                        <div class="multi-select-wrapper">
                            <div class="multi-select-trigger" id="client-multi-select-trigger" onclick="toggleClientDropdown()">
                                <span id="client-selected-text">All Clients</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </div>
                            <div class="multi-select-dropdown" id="client-dropdown" style="display: none;">
                                <div class="multi-select-search">
                                    <input type="text" id="client-search" placeholder="Search clients..." oninput="filterClients()">
                                </div>
                                <div class="multi-select-options" id="client-options">
                                    <!-- Dynamically populated -->
                                </div>
                                <div class="multi-select-actions">
                                    <button class="btn-small" onclick="selectAllClients()">Select All</button>
                                    <button class="btn-small" onclick="clearAllClients()">Clear All</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="analyzeRange()">
                        <span>üìä</span>
                        Analyze
                    </button>
                </div>
            </div>

            <div id="range-results" style="display: none;">
                <!-- Stats Grid -->
                <div class="stats-grid" style="margin-top: 25px;">
                    <div class="stat-card completed">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-label">Total Completed Tickets</div>
                        <div class="stat-value" id="range-completed">0</div>
                        <div class="stat-subtitle">In selected range</div>
                    </div>

                    <div class="stat-card processing">
                        <div class="stat-icon">‚öôÔ∏è</div>
                        <div class="stat-label">Total Processing Tickets</div>
                        <div class="stat-value" id="range-processing">0</div>
                        <div class="stat-subtitle">In selected range</div>
                    </div>

                    <div class="stat-card failed">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-label">Total Failed Tickets</div>
                        <div class="stat-value" id="range-failed">0</div>
                        <div class="stat-subtitle">In selected range</div>
                    </div>

                    <div class="stat-card callback">
                        <div class="stat-icon">üìû</div>
                        <div class="stat-label">Total Callback Required</div>
                        <div class="stat-value" id="range-callback">0</div>
                        <div class="stat-subtitle">In selected range</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-section" style="margin-top: 25px;">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-icon" style="background: #dbeafe; color: #1e40af;">üìà</div>
                            <h3 class="chart-title">Daily Ticket Trend (All Statuses)</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="rangeTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-icon" style="background: #fef3c7; color: #92400e;">üë•</div>
                            <h3 class="chart-title">Client Breakdown</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="rangeClientChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="range-no-data" class="no-data">
                <div class="no-data-icon">üìÖ</div>
                <div class="no-data-text">Select a date range to analyze ticket data</div>
            </div>
        </div>

        <!-- Token Analytics Tab -->
        <div id="token-analytics-tab" class="tab-content">
            <div class="control-panel">
                <div class="control-strip">
                    <div class="control-group">
                        <label class="control-label">Start Date</label>
                        <input type="date" id="token-start-date" class="date-input">
                    </div>

                    <div class="control-group">
                        <label class="control-label">End Date</label>
                        <input type="date" id="token-end-date" class="date-input">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Client ID</label>
                        <select id="token-client-select" class="date-input" style="min-width: 200px;">
                            <option value="all">All Clients</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="analyzeTokens()">
                        <span>üìä</span>
                        Analyze
                    </button>
                </div>
            </div>

            <div id="token-results" style="display: none;">
                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-top: 25px;">
                    <div class="stat-card" style="border-left-color: #3b82f6;">
                        <div class="stat-icon" style="background: #dbeafe; color: #1e40af;">
                            üéØ
                        </div>
                        <div class="stat-label">Total Tokens</div>
                        <div class="stat-value" id="token-total-tokens">0</div>
                        <div class="stat-subtitle">All models combined</div>
                    </div>

                    <div class="stat-card" style="border-left-color: #10b981;">
                        <div class="stat-icon" style="background: #d1fae5; color: #065f46;">
                            üí∞
                        </div>
                        <div class="stat-label">Total Cost</div>
                        <div class="stat-value" id="token-total-cost">$0.00</div>
                        <div class="stat-subtitle">Estimated spending</div>
                    </div>

                    <div class="stat-card" style="border-left-color: #f59e0b;">
                        <div class="stat-icon" style="background: #fef3c7; color: #92400e;">
                            üìù
                        </div>
                        <div class="stat-label">API Requests</div>
                        <div class="stat-value" id="token-requests">0</div>
                        <div class="stat-subtitle">Total API calls</div>
                    </div>

                    <div class="stat-card" style="border-left-color: #8b5cf6;">
                        <div class="stat-icon" style="background: #ede9fe; color: #5b21b6;">
                            ü§ñ
                        </div>
                        <div class="stat-label">Models Used</div>
                        <div class="stat-value" id="token-models">0</div>
                        <div class="stat-subtitle">Different models</div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="chart-card" style="margin-top: 25px;">
                    <div class="chart-header">
                        <div class="chart-icon" style="background: #dbeafe; color: #1e40af;">
                            üìä
                        </div>
                        <h3 class="chart-title">Token Usage by Model</h3>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="tokenChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="token-no-data" class="no-data">
                <div class="no-data-icon">üìä</div>
                <div class="no-data-text">Select a date range and client to view token analytics</div>
            </div>
        </div>
    </div>

    <!-- Modal for Ticket Details -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Tickets</h2>
                <span class="modal-close" onclick="closeTicketModal()">&times;</span>
            </div>
            <div class="modal-body">
                <table class="tickets-table" id="ticketsTable">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Client ID</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Auto QA Status</th>
                            <th>Request Status</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsTableBody">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // DATA LABELS PLUGIN
        const dataLabelsPlugin = {
            id: 'dataLabels',
            afterDatasetsDraw(chart) {
                const { ctx, data } = chart;
                ctx.save();
                data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (!meta || !meta.data) return;
                    meta.data.forEach((point, idx) => {
                        const val = dataset.data[idx];
                        if (!val || val === 0) return;
                        ctx.font = 'bold 13px sans-serif';
                        ctx.fillStyle = '#1f2937';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        let txt = val.toLocaleString();
                        if (val >= 1000000) txt = (val/1000000).toFixed(1) + 'M';
                        else if (val >= 1000) txt = (val/1000).toFixed(1) + 'K';
                        ctx.fillText(txt, point.x, point.y - 8);
                    });
                });
                ctx.restore();
            }
        };
        if (typeof Chart !== 'undefined') Chart.register(dataLabelsPlugin);

        // NUMBER ANIMATION
        function animateNumber(el, start, end, dur = 1500) {
            if (!el || start === end) { if (el) el.textContent = end.toLocaleString(); return; }
            const range = end - start, t0 = performance.now();
            function update(t) {
                const p = Math.min((t - t0) / dur, 1), ease = 1 - Math.pow(1 - p, 3);
                el.textContent = Math.floor(start + range * ease).toLocaleString();
                if (p < 1) requestAnimationFrame(update);
                else el.textContent = end.toLocaleString();
            }
            requestAnimationFrame(update);
        }

        function updateStatWithAnimation(id, val) {
            const el = document.getElementById(id);
            if (!el) return;
            const cur = parseInt(el.textContent.replace(/,/g, '')) || 0;
            el.classList.add('animate');
            animateNumber(el, cur, val);
            setTimeout(() => el.classList.remove('animate'), 1500);
        }

        // Global variables
        let charts = {
            completed: null,
            processing: null,
            failed: null,
            callback: null,
            clientCompleted: null,
            clientProcessing: null,
            clientFailed: null,
            clientCallback: null,
            rangeTrend: null,
            rangeClient: null,
            token: null
        };

        let refreshInterval = null;
        let selectedClients = new Set();
        let allClients = [];

        // ============================================================================
        // TAB SWITCHING
        // ============================================================================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');

            // Add active class to clicked button
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'overview') {
                loadOverviewData();
            } else if (tabName === 'client') {
                loadClientList();
            } else if (tabName === 'date-range') {
                loadClientListForRange();
            } else if (tabName === 'token-analytics') {
                loadTokenAnalyticsClients();
                // Set default dates (last 7 days)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 7);

                document.getElementById('token-end-date').valueAsDate = endDate;
                document.getElementById('token-start-date').valueAsDate = startDate;
            }
        }

        // ============================================================================
        // OVERVIEW TAB FUNCTIONS
        // ============================================================================
        async function loadOverviewData() {
            const dateInput = document.getElementById('overview-date');
            const selectedDate = dateInput.value;

            if (!selectedDate) {
                return;
            }

            try {
                const response = await fetch(`/api/overview?date=${selectedDate}`);
                const data = await response.json();

                // Update date banner
                const dateObj = new Date(selectedDate);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                document.getElementById('overview-date-text').textContent = formattedDate;

                // Update stats
                document.getElementById('completed-count').textContent = data.stats.completed || 0;
                document.getElementById('processing-count').textContent = data.stats.processing || 0;
                document.getElementById('failed-count').textContent = data.stats.failed || 0;
                document.getElementById('callback-count').textContent = data.stats.callback || 0;

                // Check if there's data
                const hasData = data.stats.completed > 0 || data.stats.processing > 0 || 
                               data.stats.failed > 0 || data.stats.callback > 0;

                if (hasData) {
                    document.getElementById('overview-no-data').style.display = 'none';
                    document.getElementById('overview-charts').style.display = 'flex';

                    // Create charts with FIXED scaling
                    createChart('completedChart', 'Completed', data.charts.completed || {}, '#10b981');
                    createChart('processingChart', 'Processing', data.charts.processing || {}, '#f59e0b');
                    createChart('failedChart', 'Failed', data.charts.failed || {}, '#dc2626');
                    createChart('callbackChart', 'Callback', data.charts.callback || {}, '#8b5cf6');
                } else {
                    document.getElementById('overview-no-data').style.display = 'block';
                    document.getElementById('overview-charts').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading overview:', error);
                showToast('Error loading overview data', 'error');
            }
        }

        function createChart(canvasId, label, chartData, color) {
            const ctx = document.getElementById(canvasId);

            if (charts[canvasId.replace('Chart', '')]) {
                charts[canvasId.replace('Chart', '')].destroy();
            }

            const labels = Object.keys(chartData);
            const data = Object.values(chartData);

            // Calculate max value for proper scaling
            const maxValue = Math.max(...data, 1);
            const suggestedMax = Math.ceil(maxValue * 1.1); // Add 10% padding

            charts[canvasId.replace('Chart', '')] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color + 'CC',
                        borderColor: color,
                        borderWidth: 2,
                        borderRadius: 8,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: false 
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return label + ': ' + context.parsed.y.toLocaleString() + ' tickets';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: suggestedMax,
                            grace: '10%',
                            ticks: { 
                                font: { size: 12, weight: '600' },
                                precision: 0,
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'K';
                                    }
                                    return value;
                                }
                            },
                            grid: { 
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: { 
                                font: { size: 12, weight: '600' },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { 
                                display: false 
                            }
                        }
                    }
                }
            });
        }

        function manualReload() {
            loadOverviewData();
            showToast('Data reloaded successfully', 'success');
        }

        // Auto-refresh toggle
        document.getElementById('auto-refresh-toggle').addEventListener('change', function(e) {
            const intervalInput = document.getElementById('refresh-interval');
            intervalInput.disabled = !e.target.checked;

            if (e.target.checked) {
                const seconds = parseInt(intervalInput.value);
                refreshInterval = setInterval(loadOverviewData, seconds * 1000);
                showToast(`Auto-refresh enabled (every ${seconds}s)`, 'success');
            } else {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                showToast('Auto-refresh disabled', 'success');
            }
        });

        // ============================================================================
        // CLIENT TAB FUNCTIONS
        // ============================================================================
        async function loadClientList() {
            try {
                const response = await fetch('/api/clients');
                const data = await response.json();

                const select = document.getElementById('client-id-select');
                select.innerHTML = '<option value="">-- Select a Client --</option>';

                data.client_ids.forEach(clientId => {
                    const option = document.createElement('option');
                    option.value = clientId;
                    option.textContent = clientId;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        async function loadClientData() {
            const clientId = document.getElementById('client-id-select').value;

            if (!clientId) {
                document.getElementById('client-data-container').style.display = 'none';
                document.getElementById('client-no-data').style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`/api/client/${clientId}`);
                const data = await response.json();

                if (data.total_tickets === 0) {
                    document.getElementById('client-data-container').style.display = 'none';
                    document.getElementById('client-no-data').style.display = 'block';
                    return;
                }

                document.getElementById('client-data-container').style.display = 'block';
                document.getElementById('client-no-data').style.display = 'none';

                // Update stats
                document.getElementById('client-completed-count').textContent = data.stats.completed || 0;
                document.getElementById('client-processing-count').textContent = data.stats.processing || 0;
                document.getElementById('client-failed-count').textContent = data.stats.failed || 0;
                document.getElementById('client-callback-count').textContent = data.stats.callback || 0;

                // Create charts
                createClientChart('clientCompletedChart', 'Completed', data.daily.completed || {}, '#10b981');
                createClientChart('clientProcessingChart', 'Processing', data.daily.processing || {}, '#f59e0b');
                createClientChart('clientFailedChart', 'Failed', data.daily.failed || {}, '#dc2626');
                createClientChart('clientCallbackChart', 'Callback', data.daily.callback || {}, '#8b5cf6');

            } catch (error) {
                console.error('Error loading client data:', error);
                showToast('Error loading client data', 'error');
            }
        }

        function createClientChart(canvasId, label, chartData, color) {
            const ctx = document.getElementById(canvasId);

            if (charts[canvasId.replace('Chart', '')]) {
                charts[canvasId.replace('Chart', '')].destroy();
            }

            const labels = Object.keys(chartData);
            const data = Object.values(chartData);

            // Calculate max for scaling
            const maxValue = Math.max(...data, 1);
            const suggestedMax = Math.ceil(maxValue * 1.1);

            charts[canvasId.replace('Chart', '')] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color + '33',
                        borderColor: color,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: suggestedMax,
                            grace: '10%',
                            ticks: { 
                                font: { size: 12, weight: '600' },
                                precision: 0
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            ticks: { font: { size: 12, weight: '600' } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ============================================================================
        // DATE RANGE TAB FUNCTIONS
        // ============================================================================
        async function loadClientListForRange() {
            try {
                const response = await fetch('/api/clients');
                const data = await response.json();
                allClients = data.client_ids;

                const container = document.getElementById('client-options');
                container.innerHTML = '';

                allClients.forEach(clientId => {
                    const div = document.createElement('div');
                    div.className = 'multi-select-option';
                    div.innerHTML = `
                        <input type="checkbox" value="${clientId}" onchange="updateSelectedClients()">
                        <span>${clientId}</span>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        function toggleClientDropdown() {
            const dropdown = document.getElementById('client-dropdown');
            const trigger = document.getElementById('client-multi-select-trigger');

            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'flex';
                trigger.classList.add('open');
            } else {
                dropdown.style.display = 'none';
                trigger.classList.remove('open');
            }
        }

        function filterClients() {
            const searchTerm = document.getElementById('client-search').value.toLowerCase();
            const options = document.querySelectorAll('.multi-select-option');

            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function updateSelectedClients() {
            selectedClients.clear();
            const checkboxes = document.querySelectorAll('#client-options input[type="checkbox"]:checked');
            checkboxes.forEach(cb => selectedClients.add(cb.value));

            const text = selectedClients.size === 0 ? 'All Clients' : `${selectedClients.size} client(s) selected`;
            document.getElementById('client-selected-text').textContent = text;
        }

        function selectAllClients() {
            const checkboxes = document.querySelectorAll('#client-options input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedClients();
        }

        function clearAllClients() {
            const checkboxes = document.querySelectorAll('#client-options input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedClients();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const wrapper = document.querySelector('.multi-select-wrapper');
            if (wrapper && !wrapper.contains(event.target)) {
                document.getElementById('client-dropdown').style.display = 'none';
                document.getElementById('client-multi-select-trigger').classList.remove('open');
            }
        });

        async function analyzeRange() {
            const startDate = document.getElementById('range-start-date').value;
            const endDate = document.getElementById('range-end-date').value;

            if (!startDate || !endDate) {
                showToast('Please select both start and end dates', 'error');
                return;
            }

            const resultsDiv = document.getElementById('range-results');
            const noDataDiv = document.getElementById('range-no-data');

            resultsDiv.style.display = 'none';
            noDataDiv.style.display = 'block';
            noDataDiv.innerHTML = '<div class="no-data-icon"><div class="loading"></div></div><div class="no-data-text">Analyzing data...</div>';

            try {
                let url = `/api/ticket-data-range?start_date=${startDate}&end_date=${endDate}`;

                if (selectedClients.size > 0) {
                    url += `&client_ids=${Array.from(selectedClients).join(',')}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch data');
                }

                // Update stats
                document.getElementById('range-completed').textContent = data.total_stats.completed || 0;
                document.getElementById('range-processing').textContent = data.total_stats.processing || 0;
                document.getElementById('range-failed').textContent = data.total_stats.failed || 0;
                document.getElementById('range-callback').textContent = data.total_stats.callback || 0;

                // Create trend chart
                createRangeTrendChart(data.daily_breakdown);

                // Create client breakdown chart
                createRangeClientChart(data.client_breakdown);

                noDataDiv.style.display = 'none';
                resultsDiv.style.display = 'block';

                showToast('Analysis completed successfully', 'success');

            } catch (error) {
                console.error('Range analysis error:', error);
                noDataDiv.innerHTML = '<div class="no-data-icon">‚ùå</div><div class="no-data-text">Error analyzing data: ' + error.message + '</div>';
                showToast('Error analyzing data', 'error');
            }
        }

        function createRangeTrendChart(dailyData) {
            const ctx = document.getElementById('rangeTrendChart');

            if (charts.rangeTrend) {
                charts.rangeTrend.destroy();
            }

            charts.rangeTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyData.dates || [],
                    datasets: [
                        {
                            label: 'Completed',
                            data: dailyData.completed || [],
                            borderColor: '#10b981',
                            backgroundColor: '#10b98133',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Processing',
                            data: dailyData.processing || [],
                            borderColor: '#f59e0b',
                            backgroundColor: '#f59e0b33',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Failed',
                            data: dailyData.failed || [],
                            borderColor: '#dc2626',
                            backgroundColor: '#dc262633',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Callback',
                            data: dailyData.callback || [],
                            borderColor: '#8b5cf6',
                            backgroundColor: '#8b5cf633',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: '600' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                font: { size: 12, weight: '600' },
                                precision: 0
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            ticks: { font: { size: 12, weight: '600' } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createRangeClientChart(clientData) {
            const ctx = document.getElementById('rangeClientChart');

            if (charts.rangeClient) {
                charts.rangeClient.destroy();
            }

            const clients = Object.keys(clientData).slice(0, 10);
            const totals = clients.map(client => clientData[client].total);

            charts.rangeClient = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: clients,
                    datasets: [{
                        label: 'Total Tickets',
                        data: totals,
                        backgroundColor: '#3b82f6CC',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const client = context.label;
                                    const data = clientData[client];
                                    return [
                                        `Total: ${data.total}`,
                                        `Completed: ${data.completed}`,
                                        `Processing: ${data.processing}`,
                                        `Failed: ${data.failed}`,
                                        `Callback: ${data.callback}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { 
                                font: { size: 12, weight: '600' },
                                precision: 0
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y: {
                            ticks: { font: { size: 12, weight: '600' } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ============================================================================
        // TOKEN ANALYTICS FUNCTIONS
        // ============================================================================
        async function loadTokenAnalyticsClients() {
            const select = document.getElementById('token-client-select');

            if (select.options.length > 1) {
                return;
            }

            try {
                const response = await fetch('/api/clients');
                const data = await response.json();

                select.innerHTML = '<option value="all">All Clients</option>';

                data.client_ids.forEach(clientId => {
                    const option = document.createElement('option');
                    option.value = clientId;
                    option.textContent = clientId;
                    select.appendChild(option);
                });

                console.log(`Loaded ${data.client_ids.length} clients for token analytics`);
            } catch (error) {
                console.error('Error loading clients for token analytics:', error);
                showToast('Error loading client list', 'error');
            }
        }

        async function analyzeTokens() {
            const startDate = document.getElementById('token-start-date').value;
            const endDate = document.getElementById('token-end-date').value;
            const clientId = document.getElementById('token-client-select').value;

            if (!startDate || !endDate) {
                showToast('Please select both start and end dates', 'error');
                return;
            }

            const resultsDiv = document.getElementById('token-results');
            const noDataDiv = document.getElementById('token-no-data');

            resultsDiv.style.display = 'none';
            noDataDiv.style.display = 'block';
            noDataDiv.innerHTML = '<div class="no-data-icon"><div class="loading"></div></div><div class="no-data-text">Loading token analytics...</div>';

            try {
                const params = new URLSearchParams({
                    start_date: startDate,
                    end_date: endDate
                });

                if (clientId && clientId !== 'all') {
                    params.append('client_id', clientId);
                }

                const response = await fetch(`/api/token-analytics?${params}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch token analytics');
                }

                if (data.models.length === 0) {
                    noDataDiv.innerHTML = '<div class="no-data-icon">üìä</div><div class="no-data-text">No token usage data found for the selected period</div>';
                    return;
                }

                // Update stats cards
                document.getElementById('token-total-tokens').textContent = data.totals.total_tokens.toLocaleString();
                document.getElementById('token-total-cost').textContent = '$' + data.totals.total_cost.toFixed(4);
                document.getElementById('token-requests').textContent = data.totals.request_count.toLocaleString();
                document.getElementById('token-models').textContent = data.models.length;

                // Create chart
                createTokenChart(data.models);

                noDataDiv.style.display = 'none';
                resultsDiv.style.display = 'block';

                showToast('Token analytics loaded successfully', 'success');

            } catch (error) {
                console.error('Token analytics error:', error);
                noDataDiv.innerHTML = '<div class="no-data-icon">‚ùå</div><div class="no-data-text">Error loading token analytics: ' + error.message + '</div>';
                showToast('Error loading token analytics', 'error');
            }
        }

        function createTokenChart(models) {
            const ctx = document.getElementById('tokenChart');

            if (charts.token) {
                charts.token.destroy();
            }

            const labels = models.map(m => m.model);
            const tokenData = models.map(m => m.total_tokens);
            const inputCosts = models.map(m => m.input_cost);
            const outputCosts = models.map(m => m.output_cost);
            const thoughtsCosts = models.map(m => m.thoughts_cost);
            const totalCosts = models.map(m => m.total_cost);

            const backgroundColors = models.map((_, i) => {
                const hue = (i * 360 / models.length) % 360;
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });

            const borderColors = models.map((_, i) => {
                const hue = (i * 360 / models.length) % 360;
                return `hsla(${hue}, 70%, 50%, 1)`;
            });

            // Calculate max for scaling
            const maxValue = Math.max(...tokenData, 1);
            const suggestedMax = Math.ceil(maxValue * 1.1);

            charts.token = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Tokens',
                        data: tokenData,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        borderRadius: 8,
                        inputCosts: inputCosts,
                        outputCosts: outputCosts,
                        thoughtsCosts: thoughtsCosts,
                        totalCosts: totalCosts
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: '600' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 16,
                            titleFont: { size: 15, weight: 'bold' },
                            bodyFont: { size: 14 },
                            bodySpacing: 6,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const dataset = context.dataset;

                                    return [
                                        `Total Tokens: ${context.parsed.y.toLocaleString()}`,
                                        '',
                                        `üíµ Cost Breakdown:`,
                                        `  Input Cost: $${dataset.inputCosts[index].toFixed(6)}`,
                                        `  Output Cost: $${dataset.outputCosts[index].toFixed(6)}`,
                                        dataset.thoughtsCosts[index] > 0 ? `  Thoughts Cost: $${dataset.thoughtsCosts[index].toFixed(6)}` : null,
                                        `  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`,
                                        `  Total Cost: $${dataset.totalCosts[index].toFixed(6)}`
                                    ].filter(line => line !== null);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: suggestedMax,
                            grace: '10%',
                            ticks: {
                                font: { size: 12, weight: '600' },
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'K';
                                    }
                                    return value;
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            title: {
                                display: true,
                                text: 'Total Tokens',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 12, weight: '600' },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // ============================================================================
        // MODAL FUNCTIONS
        // ============================================================================
        async function openTicketModal(status) {
            const date = document.getElementById('overview-date').value;
            if (!date) return;

            try {
                const response = await fetch(`/api/tickets?date=${date}&status=${status}`);
                const data = await response.json();

                const modal = document.getElementById('ticketModal');
                const modalTitle = document.getElementById('modalTitle');
                const tableBody = document.getElementById('ticketsTableBody');

                const statusColors = {
                    'completed': 'modal-title-completed',
                    'processing': 'modal-title-processing',
                    'failed': 'modal-title-failed',
                    'callback': 'modal-title-callback'
                };
                modalTitle.className = statusColors[status] || '';
                modalTitle.textContent = `${status.charAt(0).toUpperCase() + status.slice(1)} Tickets (${data.tickets.length})`;

                tableBody.innerHTML = '';
                data.tickets.forEach(ticket => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${ticket.ticket_id}</td>
                        <td>${ticket.client_id}</td>
                        <td><span class="status-badge ${status}">${status}</span></td>
                        <td>${new Date(ticket.created_at).toLocaleString()}</td>
                        <td>${ticket.auto_qa_status || '-'}</td>
                        <td>${ticket.request_status || '-'}</td>
                    `;
                    tableBody.appendChild(row);
                });

                modal.classList.add('is-visible');
                document.body.classList.add('modal-open');

            } catch (error) {
                console.error('Error loading tickets:', error);
                showToast('Error loading tickets', 'error');
            }
        }

        function closeTicketModal() {
            const modal = document.getElementById('ticketModal');
            modal.classList.remove('is-visible');
            document.body.classList.remove('modal-open');
        }

        document.getElementById('ticketModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTicketModal();
            }
        });

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('overview-date').value = today;

            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);

            document.getElementById('range-end-date').valueAsDate = endDate;
            document.getElementById('range-start-date').valueAsDate = startDate;

            loadOverviewData();

            document.getElementById('overview-date').addEventListener('change', loadOverviewData);
        });
    </script>
</body>
</html>